# Consolidated Gap Analysis Summary
# Original: 2026-01-12 (142 gaps)
# Refreshed: 2026-01-31
# Methodology: meta-process/patterns/30_gap-analysis.md (Pattern #30)

metadata:
  created: 2026-01-12
  refreshed: 2026-02-06
  original_total: 142
  closed: 75  # 65 prior + 6 (Plan #247) + 4 more from Plans #254, #282, #295, #299
  remaining: 82  # down from 92, after 10 closures and dedup
  new_gaps: 15
  cross_workstream_duplicates: ~10  # overlapping gaps counted in multiple workstreams
  estimated_unique_remaining: ~72
  sources:
    current: docs/architecture/current/
    target: docs/architecture/target/
  plans_completed_since_original:
    - "Plan #102: Autonomous agent loops (WS-1, WS-2)"
    - "Plan #181: Split executor.py & world.py (WS-5)"
    - "Plan #229: Conceptual model + required interfaces (WS-2, WS-5)"
    - "Plan #230: Renamed can_execute -> has_loop (WS-2)"
    - "Plan #231: has_standing <-> ledger invariant (WS-2, WS-5)"
    - "Plan #235: Kernel-protected artifacts, type immutability (WS-5)"
    - "Plan #236: Charge delegation (WS-3, WS-4)"
    - "Plan #239: Fixed broken edit_artifact + 2 bugs (WS-5)"
    - "Plan #245: Schema audit: runtime crash fix + doc cleanups (WS-5)"
    # Added 2026-02-06:
    - "Plan #247: Remove legacy tick-based resource mode (WS-3) — 6 gaps closed"
    - "Plan #254: Remove genesis artifacts, promote transfer to kernel (WS-4)"
    - "Plan #282: Ensure resource scarcity fully operational (WS-3)"
    - "Plan #295: Resource-gating architecture refactor (WS-3)"
    - "Plan #299: Eliminate legacy agent system (WS-2)"
  workstream_files:
    - ws1_execution_model.yaml
    - ws2_agents.yaml
    - ws3_resources.yaml
    - ws4_genesis.yaml
    - ws5_artifacts.yaml
    - ws6_infrastructure.yaml

# =============================================================================
# GAP SUMMARY BY WORKSTREAM
# =============================================================================

workstream_summary:
  - id: WS-1
    name: "Execution Model"
    file: ws1_execution_model.yaml
    original_count: 23
    closed: 13
    still_open: 2
    modified: 8
    new: 0
    remaining: 10
    key_remaining:
      - GAP-EXEC-002: "Agent sleep: infrastructure exists, not agent-accessible (L, medium)"
      - GAP-EXEC-017: "Worker process: thread pool exists, not process-isolated (XL, high)"
      - GAP-EXEC-022: "SQLite-backed ledger: only state store uses SQLite (L, medium)"
    description: |
      Foundational transformation COMPLETE. Plan #102 removed tick-based execution,
      AgentLoop provides continuous autonomous loops, RateTracker handles resource
      gating. Remaining work: agent-facing sleep API, worker process isolation,
      SQLite ledger backend, context hash verification.

  - id: WS-2
    name: "Agents"
    file: ws2_agents.yaml
    original_count: 22
    closed: 10
    still_open: 4
    modified: 8
    new: 3
    remaining: 15
    key_remaining:
      - GAP-AGENT-004: "Config rights trading (L, medium)"
      - GAP-AGENT-007: "Agent state observability (M, low) -> enables vulture rescue"
      - GAP-AGENT-019: "Permission check costs not charged (L, medium)"
      - GAP-AGENT-024: "Cognitive self-modification safety (M, medium) [NEW]"
    description: |
      45% closed. All foundational gaps done (unified ontology, autonomous loops,
      event bus, memory as artifact). Remaining: config rights trading, state
      observability, memory quotas, permission check costs. 3 new gaps emerged
      from implementation experience.

  - id: WS-3
    name: "Resources"
    file: ws3_resources.yaml
    original_count: 30
    closed: 14  # +6 from Plan #247 (legacy tick removal), +2 from Plans #282, #295
    still_open: 6
    modified: 8
    new: 2
    remaining: 16
    key_remaining:
      - GAP-RES-008: "ProcessPoolExecutor for worker isolation (XL, high)"
      - GAP-RES-004: "Per-agent LLM rate allocation (M, medium)"
      - GAP-RES-031: "Charge delegation vs has_standing reconciliation (M, medium) [NEW]"
    description: |
      Significantly improved since 2026-01-31 refresh. Plan #247 removed ALL legacy
      tick-based resource mode, closing 6 gaps (GAP-RES-018/019/028/029/030/033).
      Plans #282 and #295 addressed resource scarcity operational gaps. Remaining:
      per-agent rate allocation cluster and worker isolation chain.

  - id: WS-4
    name: "Genesis/Contracts"
    file: ws4_genesis.yaml
    original_count: 27
    closed: 18
    still_open: 1
    modified: 8
    new: 5
    remaining: 14
    key_remaining:
      - GAP-GEN-042: "Contracts cannot invoke/call_llm (L, high) [NEW]"
      - GAP-GEN-040: "Genesis contracts are Python classes, not artifacts (L, medium) [NEW]"
      - GAP-GEN-041: "Charge delegation not wired to contracts (M, medium) [NEW]"
      - GAP-GEN-010: "Policy field vestigial but still exists (M, medium)"
    description: |
      67% closed. Plan #100 was the major milestone (10+ gaps). Contract system
      fully functional with 5 genesis contracts, custom ExecutableContracts,
      caching, depth limits, and timeout. Remaining: contract sandbox enrichment
      (invoke/LLM), structural alignment (genesis as artifacts), mint cleanup.

  - id: WS-5
    name: "Artifacts/Executor/Kernel"
    file: ws5_artifacts.yaml
    original_count: 22
    closed: 14
    still_open: 3
    modified: 5
    new: 4
    remaining: 12
    key_remaining:
      - GAP-ART-012: "Expand contract execution namespace (L, medium)"
      - GAP-ART-019: "Resource limits for contracts (L, medium)"
      - GAP-ART-023: "Policy dict coexists with access_contract_id (M, medium) [NEW]"
      - GAP-ART-026: "handle_request bypasses contract system (S, low) [NEW]"
    description: |
      Most improved workstream (64% closed). Plan #100 alone closed 12 of 22
      original gaps. Contract system fully operational. Remaining: sandbox
      enrichment (overlaps WS-4), policy dict cleanup, contract composition,
      kernel storage abstraction.

  - id: WS-6
    name: "Infrastructure"
    file: ws6_infrastructure.yaml
    original_count: 18
    closed: 4
    still_open: 12
    modified: 2
    new: 0
    remaining: 14
    key_remaining:
      - GAP-INFRA-006: "PostgreSQL for distributed ledger (L, medium)"
      - GAP-INFRA-011: "Local LLM support (XL, high)"
      - GAP-INFRA-012: "Git-backed artifact store (L, medium)"
      - GAP-INFRA-003: "Token bucket rate calibration to container CPU (M, low)"
    description: |
      Only 4 closed (all Docker-related, Plan #3). Remaining gaps are mostly
      scaling and advanced features. Single-node deployment works. Multi-container
      (PostgreSQL, Redis) and advanced features (local LLM, Git store) untouched.
      No new gaps - target architecture stable.

# =============================================================================
# CROSS-WORKSTREAM OVERLAPS
# =============================================================================

cross_workstream_overlaps:
  description: |
    Several gaps describe the same underlying work from different workstream
    perspectives. Implementing one typically closes or substantially addresses
    the others. ~10 gaps are near-duplicates, reducing effective unique remaining
    from 92 to ~82.

  clusters:
    - topic: "Contract sandbox enrichment"
      gaps: [GAP-GEN-042, GAP-ART-011, GAP-ART-012]
      description: "Adding invoke/call_llm/charge to contract execution namespace"

    - topic: "Policy dict removal"
      gaps: [GAP-GEN-010, GAP-ART-023]
      description: "Remove vestigial policy field from Artifact model"

    - topic: "Contract composition"
      gaps: [GAP-GEN-009, GAP-ART-009]
      description: "Support multiple contracts per artifact"

    - topic: "Absolute time injection"
      gaps: [GAP-EXEC-005, GAP-AGENT-021]
      description: "Add ISO 8601 wall-clock timestamp to agent context"

    - topic: "Worker process isolation"
      gaps: [GAP-EXEC-017, GAP-RES-008]
      description: "ProcessPoolExecutor upgrade for true per-worker isolation"

    - topic: "Charge delegation integration"
      gaps: [GAP-AGENT-025, GAP-RES-031, GAP-GEN-041]
      description: "Wire Plan #236 charge delegation into agents/contracts/resource model"

    - topic: "Permission check costs"
      gaps: [GAP-RES-021, GAP-AGENT-019]
      description: "Charge requesters for permission checks (partial overlap)"

# =============================================================================
# COMPLEXITY DISTRIBUTION (remaining gaps only)
# =============================================================================

complexity_summary:
  description: "Complexity of ~82 remaining gaps (estimated after 10 closures)"
  S: 25
  M: 34
  L: 19
  XL: 4

# =============================================================================
# RISK DISTRIBUTION (remaining gaps only)
# =============================================================================

risk_summary:
  description: "Risk of ~82 remaining gaps (estimated after 10 closures)"
  low: 46
  medium: 30
  high: 6

# =============================================================================
# CRITICAL PATH - UPDATED
# =============================================================================

critical_path:
  description: |
    Phase 1 foundations (original analysis) are ALL CLOSED:
    - GAP-EXEC-001 (autonomous loops) -> Plan #102
    - GAP-AGENT-001 (unified ontology) -> Plan #229/230
    - GAP-GEN-001 (contract system) -> Plan #100
    - GAP-RES-001 (RateTracker) -> Plan #53

    The critical path has shifted from foundational to integration/enrichment.

  phase_A_high_value:
    description: "High-value remaining work that unlocks target architecture vision"
    items:
      - GAP-GEN-042: "Contract sandbox enrichment (invoke/call_llm) - blocks ADR-0003"
      - GAP-GEN-041: "Charge delegation in contracts - enables full cost model"
      - "GAP-RES-004/013/022: Per-agent rate allocation cluster - enables market allocation"
      - GAP-AGENT-007: "Agent state observability -> enables vulture capitalist pattern"

  phase_B_cleanup:
    description: "Medium-value cleanup that removes legacy and aligns with target"
    items:
      - "GAP-RES-018/019/028/029/030: Legacy tick mode removal (closes 5 gaps)"
      - "GAP-GEN-010 + GAP-ART-023: Policy dict removal"
      - "GAP-EXEC-002/011: Agent-facing sleep API"
      - GAP-AGENT-004: "Config rights trading"

  phase_C_infrastructure:
    description: "Lower-value infrastructure work, can be deferred"
    items:
      - "GAP-EXEC-017 + GAP-RES-008: Worker process isolation (XL, high risk)"
      - "GAP-INFRA-006/007/008/009/010: Multi-container scaling"
      - "GAP-INFRA-011: Local LLM support (XL, high risk)"
      - "GAP-INFRA-012: Git-backed artifact store"

# =============================================================================
# PARALLELIZABLE WORKSTREAMS - UPDATED
# =============================================================================

parallel_workstreams:
  description: |
    With foundations complete, the remaining work is more modular.
    Multiple streams can proceed concurrently.

  stream_A_contract_enrichment:
    name: "Contract Sandbox Enrichment"
    gaps: [GAP-GEN-042, GAP-GEN-041, GAP-ART-011, GAP-ART-012]
    description: "Add invoke/call_llm/charge to contract sandbox"
    can_parallel_with: [stream_B, stream_C, stream_D]

  stream_B_resource_model:
    name: "Resource Model Completion"
    gaps: [GAP-RES-004, GAP-RES-013, GAP-RES-022, GAP-RES-027]
    description: "Per-agent rate allocation with provider limit partitioning"
    can_parallel_with: [stream_A, stream_C, stream_D]

  stream_C_legacy_removal:
    name: "Legacy Mode Removal"
    gaps: [GAP-RES-018, GAP-RES-019, GAP-RES-028, GAP-RES-029, GAP-RES-030, GAP-RES-033]
    status: "CLOSED — All gaps in this stream closed by Plan #247"
    description: "Tick-based fallback paths removed, rate limiting enabled by default"
    can_parallel_with: []

  stream_D_agent_enrichment:
    name: "Agent Capability Enrichment"
    gaps: [GAP-AGENT-007, GAP-AGENT-013, GAP-EXEC-002, GAP-EXEC-011]
    description: "State observability, vulture rescue, agent-facing sleep API"
    can_parallel_with: [stream_A, stream_B, stream_C]

  stream_E_cleanup:
    name: "Structural Cleanup"
    gaps: [GAP-GEN-010, GAP-ART-023, GAP-GEN-040, GAP-ART-025]
    description: "Policy dict removal, genesis contracts as artifacts, naming"
    can_parallel_with: [stream_A, stream_B, stream_C, stream_D]

# =============================================================================
# IMPLEMENTATION RECOMMENDATIONS - UPDATED
# =============================================================================

recommendations:
  - title: "Foundations are done - shift to integration"
    description: |
      All Phase 1 foundational gaps are closed. The system has autonomous loops,
      unified ontology, contract-based access control, and rate tracking. Focus
      shifts from building foundations to enriching and connecting existing systems.

  - title: "Legacy tick mode removal — DONE (Plan #247)"
    description: |
      Plan #247 removed all legacy tick-based fallback paths, closing 6 gaps
      simultaneously (GAP-RES-018/019/028/029/030/033). This was the highest-ROI
      single plan completion since the original gap analysis.

  - title: "Contract sandbox enrichment is highest-value remaining work"
    description: |
      GAP-GEN-042 (contracts cannot invoke/call_LLM) is the single highest-impact
      remaining gap. It blocks the full ADR-0003 vision of "contracts can do anything."
      However, it carries high risk due to re-entrancy and security concerns.

  - title: "WS-3 (Resources) needs most attention"
    description: |
      27 of 92 remaining gaps are in Resources. The per-agent rate allocation
      cluster (4 gaps) and legacy removal cluster (6 gaps) are the two highest-
      value groups to address.

  - title: "WS-6 (Infrastructure) can be deferred safely"
    description: |
      Infrastructure gaps are largely additive scaling features. Single-node
      deployment works. Multi-container and advanced features can wait until
      agent count exceeds ~50.

  - title: "Cross-workstream deduplication saves effort"
    description: |
      ~10 of 92 remaining gaps are near-duplicates across workstreams.
      Implementing one cluster (e.g., contract sandbox enrichment) typically
      closes 2-3 gap entries simultaneously.

# =============================================================================
# GAP → PLAN CROSS-REFERENCE (Plan #284)
# =============================================================================
# Maps gaps to their implementing plans (where known).
# This enables tracing: Gap → Plan → Implementation

gap_plan_mapping:
  description: |
    Cross-reference from gap IDs to implementing plans.
    Updated as plans close gaps.

  closed_gaps:
    GAP-EXEC-001: { plan: 102, title: "Autonomous agent loops" }
    GAP-AGENT-001: { plan: [229, 230], title: "Unified ontology" }
    GAP-GEN-001: { plan: 100, title: "Contract system foundation" }
    GAP-RES-001: { plan: 53, title: "RateTracker implementation" }
    GAP-ART-001: { plan: 181, title: "Split executor.py & world.py" }
    GAP-AGENT-014: { plan: 231, title: "has_standing <-> ledger invariant" }
    # Added 2026-02-06:
    GAP-RES-018: { plan: 247, title: "Remove legacy tick-based resource mode" }
    GAP-RES-019: { plan: 247, title: "Remove legacy tick-based resource mode" }
    GAP-RES-028: { plan: 247, title: "Remove legacy tick-based resource mode" }
    GAP-RES-029: { plan: 247, title: "Remove legacy tick-based resource mode" }
    GAP-RES-030: { plan: 247, title: "Remove legacy tick-based resource mode" }
    GAP-RES-033: { plan: 247, title: "Remove legacy tick-based resource mode" }

  # Gaps with active or planned work
  in_progress_gaps:
    GAP-RES-XXX: { plan: [282, 295], title: "Resource scarcity and allocation", status: "complete" }

  # Reference for commonly-asked-about gaps
  notable_remaining:
    GAP-GEN-042: { plan: null, title: "Contracts cannot invoke/call_llm", notes: "High-value but risky" }
    GAP-RES-004: { plan: null, title: "Per-agent LLM rate allocation", notes: "Part of resource cluster" }
    GAP-EXEC-017: { plan: null, title: "Worker process isolation", notes: "XL complexity" }
    GAP-INFRA-011: { plan: null, title: "Local LLM support", notes: "XL complexity" }
