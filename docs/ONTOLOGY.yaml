# =============================================================================
# ONTOLOGY - Precise entity definitions (machine-readable)
# =============================================================================
# Renamed from CONCEPTUAL_MODEL.yaml in Plan #294.
#
# This file defines the precise, field-level schema of entities in the system.
# It's the bottom of the document hierarchy - most concrete layer before code.
#
# Document Hierarchy (Plan #294):
#   Thesis → PRD → Domain Model → ADR → Ontology (this file) → Code
#
# See: docs/prd/ for capabilities, docs/domain_model/ for concepts
# Last verified: 2026-02-08 (Plan #308: added update_metadata action type)
# =============================================================================

version: 4
last_updated: "2026-02-06"  # Plan #306: created_by auth fix, PermissionResult.recipient
status: current_implementation
source_of_truth: "src/world/artifacts.py, src/world/actions.py, src/world/kernel_interface.py"

# =============================================================================
# ARTIFACT - The Primal Entity (21 dataclass fields)
# =============================================================================
# Source: src/world/artifacts.py:120-194

artifact:
  definition: "Any persistent, addressable object in the system"
  is_primal: true

  # Required fields (no default)
  required_fields:
    id: { type: str, mutable: false }
    type: { type: str, mutable: false, note: "Immutable after creation (Plan #235)" }
    content: { type: str, mutable: true }
    created_by: { type: str, mutable: false, note: "ADR-0016: immutable metadata" }
    created_at: { type: str, mutable: false }
    updated_at: { type: str, mutable: true }

  # Optional fields (have defaults)
  optional_fields:
    executable: { type: bool, default: false }
    code: { type: str, default: '""' }
    policy: { type: dict, default: "default_policy()" }
    has_standing: { type: bool, default: false, note: "Can hold resources" }
    has_loop: { type: bool, default: false, note: "Runs autonomously" }
    memory_artifact_id: { type: "str | None", default: "None" }
    deleted: { type: bool, default: false }
    deleted_at: { type: "str | None", default: "None" }
    deleted_by: { type: "str | None", default: "None" }
    interface: { type: "dict | None", default: "None", note: "MCP-compatible schema" }
    genesis_methods: { type: "dict | None", default: "None" }
    depends_on: { type: list, default: "[]" }
    access_contract_id: { type: str, default: '"kernel_contract_freeware"' }
    metadata: { type: dict, default: "{}" }
    kernel_protected: { type: bool, default: false, note: "Plan #235 Phase 1" }
    capabilities: { type: list, default: "[]", note: "Plan #254: e.g., ['can_mint']" }

  computed_properties:
    price: "policy['invoke_price'] (backwards compat)"
    is_principal: "has_standing == True"
    is_agent: "has_standing and has_loop"

# =============================================================================
# AGENT COGNITIVE ARCHITECTURE (ADR-0027)
# =============================================================================
# BabyAGI-style artifact constellation for agent cognition.
# These are PATTERNS of artifact usage, not dataclass fields.
# See: docs/domain_model/agents.yaml for conceptual model
# See: docs/prd/agents.md for capability requirements

agent_constellation:
  description: |
    Each agent maintains a constellation of related artifacts that together
    constitute its cognitive state. The naming convention is {agent_id}_{artifact_type}.

  recommended_artifacts:
    goals:
      naming: "{agent_id}_goals"
      type: data
      purpose: "Goal hierarchy (strategic → tactical → tasks)"
      structure: |
        strategic_goals: list of long-term objectives
        tactical_goals: list of medium-term objectives serving strategic goals
        current_tasks: list of immediate work items
      enables: [long-term-planning]

    task_queue:
      naming: "{agent_id}_task_queue"
      type: data
      purpose: "Prioritized work items (BabyAGI-style)"
      structure: |
        tasks: list of {id, description, priority, goal_ref, status}
        last_executed: task_id
        generated_from: list of insight/outcome refs
      enables: [long-term-planning, adaptation]

    world_model:
      naming: "{agent_id}_world_model"
      type: data
      purpose: "Understanding of ecosystem"
      structure: |
        agents: dict of {agent_id: observations}
        resources: dict of {resource: availability}
        artifacts: dict of {artifact_id: notes}
        last_updated: timestamp
      enables: [ecosystem-awareness, niche-finding, collaboration]

    self_model:
      naming: "{agent_id}_self_model"
      type: data
      purpose: "Understanding of self, niche hypothesis"
      structure: |
        capabilities: list of what I can do well
        limitations: list of what I struggle with
        niche_hypothesis: current belief about my niche
        evidence: list of observations supporting/refuting hypothesis
      enables: [adaptation, niche-finding, self-modification]

    strategy:
      naming: "{agent_id}_strategy"
      type: data
      purpose: "Current approach to achieving goals"
      structure: |
        current_strategy: description of approach
        priorities: ordered list of focus areas
        thresholds: when to change strategy
      enables: [adaptation, niche-finding]

    memory:
      naming: "{agent_id}_memory"
      type: data
      purpose: "Persistent learnings (queryable)"
      structure: |
        entries: list of {timestamp, type, content, tags}
        indices: optional search indices
      enables: [adaptation, long-term-planning]
      note: "See ADR-0009 for memory-as-artifact pattern"

  notes: |
    - These are RECOMMENDED, not REQUIRED by kernel
    - Agents can modify their own constellation
    - Internal structure is agent's choice (YAML, JSON, prose)
    - Kernel only sees artifacts; constellation is a usage pattern

# =============================================================================
# ACTIONS (12 core + 2 deprecated)
# =============================================================================
# Source: src/world/actions.py:13-40

actions:
  storage:
    description: "Artifact CRUD + metadata, go through contract permission checking (ADR-0019)"
    operations: [read_artifact, write_artifact, edit_artifact, delete_artifact, update_metadata]
    notes:
      update_metadata: "Set/delete metadata key on artifact. Protected keys (authorized_writer, authorized_principal) blocked at executor level (Plan #308, ADR-0028)"

  execution:
    description: "Code execution, goes through contract permission checking"
    operations: [invoke_artifact]

  value:
    description: "Scrip management (Plan #254, #269)"
    operations: [transfer, mint, submit_to_task]
    notes:
      transfer: "Move scrip between principals, validates balance"
      mint: "Submit artifact to auction-based mint (Plan #254)"
      submit_to_task: "Submit artifact to task-based mint for test evaluation (Plan #269)"

  observation:
    description: "Read-only kernel state access"
    operations: [noop, query_kernel]

  signal:
    description: "Subscription management"
    operations: [subscribe_artifact, unsubscribe_artifact]
    note: "subscribe_artifact does NOT check read permission (known gap)"

  deprecated:
    description: "Convenience actions, use edit_artifact on self instead"
    operations: [configure_context, modify_system_prompt]

# =============================================================================
# KERNEL INTERFACE
# =============================================================================
# Source: src/world/kernel_interface.py

kernel_interface:
  kernel_state:
    description: "Read-only (11 methods)"
    methods:
      - "get_balance(principal_id) -> int"
      - "get_resource(principal_id, resource) -> float"
      - "get_llm_budget(principal_id) -> float"
      - "list_artifacts_by_owner(created_by) -> list[str]"
      - "get_artifact_metadata(artifact_id) -> dict | None"
      - "read_artifact(artifact_id, caller_id) -> str | None"
      - "get_mint_submissions() -> list[dict]"
      - "get_mint_history(limit) -> list[dict]"
      - "get_quota(principal_id, resource) -> float"
      - "get_available_capacity(principal_id, resource) -> float"
      - "would_exceed_quota(principal_id, resource, amount) -> bool"

  kernel_actions:
    description: "Write operations with verified caller (15 methods)"
    methods:
      - "transfer_scrip(caller_id, to, amount) -> bool"
      - "transfer_resource(caller_id, to, resource, amount) -> bool"
      - "transfer_llm_budget(caller_id, to, amount) -> bool"
      - "write_artifact(caller_id, artifact_id, content, type) -> bool"
      - "submit_for_mint(caller_id, artifact_id, bid) -> dict"
      - "cancel_mint_submission(caller_id, submission_id) -> bool"
      - "transfer_quota(from_id, to_id, resource, amount) -> bool"
      - "consume_quota(principal_id, resource, amount) -> bool"
      - "install_library(caller_id, library_name, version) -> dict"
      - "create_principal(principal_id, starting_scrip) -> bool"
      - "update_artifact_metadata(caller_id, artifact_id, key, value) -> bool"
      - "modify_protected_content(artifact_id, content, code, metadata) -> bool"
      - "grant_charge_delegation(caller_id, delegate_id, max_per_call, max_per_window) -> bool"
      - "revoke_charge_delegation(caller_id, delegate_id) -> bool"
      - "authorize_charge(caller_id, payer_id, amount) -> bool"

# =============================================================================
# PERMISSION SYSTEM (ADR-0019 - current)
# =============================================================================

permission_system:
  architecture: "ADR-0019 (kernel-mediated contract checking)"
  flow: "Agent → Kernel → Contract.check_permission() → Allow/Deny → Kernel enforces"
  default_contract: "kernel_contract_freeware"
  kernel_contracts:
    - "freeware (public read/invoke, owner-only write)"
    - "self_owned (owner-only everything)"
    - "private (owner-only)"
    - "public (everyone)"
    - "transferable_freeware (freeware + authorized_writer)"

# =============================================================================
# RESOURCES
# =============================================================================

resources:
  types:
    depletable: { examples: ["llm_dollars"], note: "Gone forever" }
    allocatable: { examples: ["disk_bytes"], note: "Reusable when freed" }
    renewable: { examples: ["llm_calls_per_minute"], note: "Token bucket rate-limited" }
  scrip: "Internal accounting unit, kernel-tracked (not an artifact)"

# =============================================================================
# LABELS (Conceptual Only - NOT a dataclass field)
# =============================================================================

labels:
  status: "CONCEPTUAL ONLY"
  invariant: "No kernel or artifact logic may branch on labels"
  common: [data, service, contract, right, principal, autonomous_principal, agent]

# =============================================================================
# SYSTEM LAYERS
# =============================================================================

layers:
  infrastructure: "External reality (machines, APIs, costs)"
  configuration: "Operator parameters (config.yaml)"
  kernel: "Storage + identity + physics enforcement"

# =============================================================================
# TARGET ARCHITECTURE (ADR-0024 - NOT IMPLEMENTED)
# =============================================================================

target_architecture:
  status: "NOT YET IMPLEMENTED — See Plan #234"
  key_change: "Artifacts handle own access via handle_request(caller, operation, args)"
  kernel_role: "Routes only (does not check permissions)"
  reference: "CONCEPTUAL_MODEL_FULL.yaml Part 2"

# =============================================================================
# RELATIONSHIPS
# =============================================================================

relationships:
  implications:
    - "has_loop → has_standing"
    - "agent → autonomous_principal → principal"
  universal:
    - "Everything is an artifact"
    - "Every artifact has one governing contract (access_contract_id)"
    - "created_by is immutable metadata (ADR-0016)"
    - "Labels are NOT mutually exclusive"
  owner_term: "DOES NOT EXIST — use 'created_by' for creator, 'contract' for access"

# =============================================================================
# REFERENCES
# =============================================================================

references:
  full_model: "docs/CONCEPTUAL_MODEL_FULL.yaml"
  decisions:
    ADR-0016: "created_by as immutable metadata"
    ADR-0019: "Kernel-mediated permission checking (current)"
    ADR-0024: "Artifact self-handled access (target, not implemented)"
  code_gaps:
    subscribe_permission: "Needs read check on target"
    handle_request: "Plan #234 (not implemented)"
    invariants: "Plan #231"
