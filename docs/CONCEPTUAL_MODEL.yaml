# =============================================================================
# CONCEPTUAL MODEL - Machine-readable architecture definition
# =============================================================================
# This is the canonical conceptual model for the Agent Ecology system.
# Status: ACCEPTED - ADR-0024
#
# For historical reasoning, see: docs/explorations/
# For full version with examples, see: CONCEPTUAL_MODEL_FULL.yaml
# =============================================================================

version: 2
last_updated: "2026-01-31"
status: accepted

# =============================================================================
# IMPLEMENTATION STATUS - IMPORTANT
# =============================================================================
# This model describes the TARGET architecture per ADR-0024.
# The current implementation follows ADR-0019 (superseded).
#
# KEY DIFFERENCES (Current vs This Model):
# ┌─────────────────────┬──────────────────────────────┬────────────────────────────┐
# │ Aspect              │ Current Implementation       │ This Model (Target)        │
# ├─────────────────────┼──────────────────────────────┼────────────────────────────┤
# │ Handler interface   │ run(*args)                   │ handle_request(caller,     │
# │                     │                              │   operation, args)         │
# │ Permission checking │ Kernel checks contract       │ Artifact handles in code   │
# │                     │ BEFORE artifact runs         │                            │
# │ Kernel role         │ Routes AND interprets        │ Routes only                │
# │ Defaults            │ Freeware contract fallback   │ No defaults                │
# │ access_contract_id  │ Kernel uses for checking     │ Just metadata              │
# │ charge_to           │ Not implemented              │ Artifact directs costs     │
# └─────────────────────┴──────────────────────────────┴────────────────────────────┘
#
# Migration tracked in: Plan #234 (ADR-0024 Handle Request Migration)
# =============================================================================

# Code gaps tracked separately:
# - handle_request interface (Plan #234) - MAJOR: core interface not implemented
# - charge_to cost routing (GAP-ART-004) - artifacts can't direct costs
# - subscribe_artifact permission (needs read check)
# - kernel invariants (Plan #231)
# =============================================================================
# ARTIFACT - The Primal Entity
# =============================================================================

artifact:
  definition: "Any persistent, addressable object in the system"
  is_primal: true  # Everything else extends this

  required_fields:
    id:
      type: string
      description: "Unique identifier"
    content:
      type: string
      description: "Stored data (may be empty)"
    code:
      type: string
      description: "Handler code (ADR-0024: all artifacts have handlers)"
    created_by:
      type: string
      description: "Principal who created this (immutable)"
      mutable: false

  # ADR-0024: Artifacts handle their own access in code
  # No kernel defaults. See docs/explorations/access_control.md

# =============================================================================
# INTERFACE - Required on All Artifacts
# =============================================================================

interface:
  definition: "Schema describing what an artifact IS and what it can DO"
  required_on: "ALL artifacts"
  influences: ["MCP (tool definitions)", "StructGPT (linearization)"]

  required_fields:
    description:
      type: string
      description: "Human-readable summary"
    labels:
      type: "list[string]"
      description: "Convenience labels (NOT mutually exclusive)"
      common_values: ["data", "service", "contract", "right", "principal", "agent"]

  optional_fields:
    methods:
      type: "list[MethodSchema]"
      description: "Callable operations"
    schema:
      type: "JSONSchema"
      description: "Structure of content"
    linearization:
      type: string
      description: "Template for LLM presentation"
    inputSchema:
      type: "JSONSchema"
    outputSchema:
      type: "JSONSchema"

# =============================================================================
# PROPERTIES
# =============================================================================

properties:
  structural:
    executable:
      type: bool
      description: "Has runnable code"
    has_standing:
      type: bool
      description: "Can hold resources and bear costs"
      note: "Plan #231 proposes tight coupling with ledger"
    has_loop:
      type: bool
      description: "Runs autonomously"
      implies: has_standing
      code_name: "has_loop"

  interface_patterns:
    implements_check_permission:
      description: "Implements check_permission(caller, action, target) -> bool"
      makes_it: "a contract"
    content_is_resource_claim:
      description: "Content follows resource claim schema"
      makes_it: "a right"
    exposes_methods:
      description: "Interface defines callable methods"
      makes_it: "a service"

  decision_engine:
    options: ["LLM-based (agent)", "Rules/code-based", "RL policy", "External API"]

# =============================================================================
# LABELS (Named Combinations)
# =============================================================================

labels:
  data:
    properties: "!executable"
    description: "Stores information, not runnable"

  service:
    properties: "executable, exposes_methods, !has_loop"
    description: "Provides callable methods"

  contract:
    properties: "executable, implements_check_permission"
    description: "Answers permission questions"
    governs: [read, write, edit, invoke, delete]

  right:
    properties: "content_is_resource_claim"
    description: "Claim on physical capacity"
    content_schema:
      amount: { type: number }
      resource: { type: string }
      resource_type: { type: enum, values: ["depletable", "allocatable", "renewable"] }

  principal:
    properties: "has_standing"
    description: "Can hold resources and bear costs"

  autonomous_principal:
    properties: "has_standing, has_loop"
    description: "Runs independently"

  agent:
    properties: "has_standing, has_loop, LLM-based"
    description: "Autonomous principal using LLM"

# INVARIANT: No kernel or artifact logic may branch on labels.
# Labels are observational only (discovery, filtering, search).

# =============================================================================
# ACTIONS
# =============================================================================

actions:
  core:
    description: "Route through artifact handler (ADR-0024)"
    operations: [read, write, edit, invoke, delete]

  kernel:
    description: "No permission needed"
    operations: [noop, query_kernel]

  convenience:
    description: "Shortcuts for edit_artifact"
    operations: [subscribe_artifact, unsubscribe_artifact, configure_context, modify_system_prompt]
    note: "subscribe_artifact needs read permission check (code gap)"

# =============================================================================
# RESOURCES
# =============================================================================

resources:
  definition: "Scarce physical capacities"

  concerns:
    permission: "Contract on the right artifact"
    measurement: "Kernel (physics)"
    scarcity: "Kernel (physics)"

  types:
    depletable:
      description: "Once consumed, gone forever"
      examples: ["llm_dollars"]
    allocatable:
      description: "Finite but reusable when freed"
      examples: ["disk_bytes", "memory_bytes"]
    renewable:
      description: "Replenishes over time (rate-limited)"
      examples: ["llm_calls_per_minute"]

  consumption:
    insight: "Consuming from a right IS writing to the right artifact"
    note: "Contract on the right decides who can consume"

# =============================================================================
# CONTRACTS (ADR-0024)
# =============================================================================

contracts:
  definition: "Artifacts that answer permission questions"

  core_principle: |
    Contracts are just artifacts. Kernel does NOT check them automatically.
    Artifacts that want to delegate invoke a contract from their handler.
    See docs/explorations/access_control.md

  what_kernel_does:
    - "Routes requests to artifact handlers"
    - "Provides verified caller identity"
    - "Enforces physics (scarcity, storage, immutability)"

  what_kernel_does_not:
    - "Check permissions"
    - "Interpret contracts"
    - "Provide access control defaults"

# =============================================================================
# CREATED_BY (ADR-0016)
# =============================================================================

created_by:
  type: "Metadata field"
  mutable: false
  meaning: "Historical fact: who created this artifact"
  permissions_implied: "NONE - contracts decide everything"

# =============================================================================
# "OWNER" - Term Does Not Exist
# =============================================================================

owner:
  status: "TERM DOES NOT EXIST"
  instruction: "Do not use. Causes confusion."
  why: "Rights are Ostrom-style bundles, not unified ownership"
  instead: "Ask the contract. May be undecidable."

# =============================================================================
# SYSTEM LAYERS
# =============================================================================

layers:
  infrastructure:
    description: "External reality"
    includes: ["Real machines", "Container limits", "External APIs", "Real costs"]

  configuration:
    description: "Parameters set by operator"
    includes: ["Resource limits", "Agent definitions", "Genesis artifacts", "Model selection"]

  kernel:
    description: "The system itself"
    stores: ["World state (artifacts)", "World history (immutable log)", "Measurement state"]
    enforces: ["Scarcity", "Immutability", "Permission checks are metered and bounded"]
    provides: ["Read interface", "Write interface"]

  diagram: |
    Infrastructure (external reality)
           ↓ constrains
    Configuration (operator parameters)
           ↓ parameterizes
    Kernel (storage, identity, physics)

# =============================================================================
# KERNEL RESPONSIBILITIES (ADR-0024)
# =============================================================================

kernel_responsibilities:
  does:
    storage: "World state, history, measurement"
    identity: "Verified caller identity (can't be spoofed)"
    physics: "Scarcity, immutability, resource measurement"
    routing: "Route requests to artifact handlers"

  does_not:
    - "Permission checking (artifacts handle in code)"
    - "Access control defaults"
    - "Interpret contracts"

  opacity: "Kernel treats handle_request as opaque code - executes, does not interpret"

  reference: "docs/explorations/access_control.md"

# =============================================================================
# HANDLE_REQUEST INTERFACE (ADR-0024) - TARGET, NOT CURRENT
# =============================================================================

handle_request:
  implementation_status: "NOT YET IMPLEMENTED - See Plan #234"
  current_interface: "run(*args) with caller_id as injected global"
  description: "Standard interface every artifact implements"

  signature: "def handle_request(caller: str, operation: str, args: dict) -> dict"

  parameters:
    caller: "Verified by kernel"
    operation: "[read, write, invoke, delete]"
    args: "Operation-specific"

  return_value:
    allowed: bool
    charge_to: "enum [caller, target, contract, pool] - overrides cost_model for this frame"
    result: any
    error: "string (optional)"

  reference: "docs/explorations/access_control.md"

# =============================================================================
# OBSERVABILITY COMMITMENT
# =============================================================================

observability:
  commitment: "All events logged with sufficient detail for post hoc surplus analysis"

# =============================================================================
# RELATIONSHIPS
# =============================================================================

relationships:
  implications:
    - "has_loop → has_standing"
    - "agent → autonomous_principal → principal"

  universal:
    - "Everything is an artifact"
    - "created_by is immutable metadata (ADR-0016)"
    - "Labels are NOT mutually exclusive"

# =============================================================================
# REFERENCES
# =============================================================================

references:
  decisions:
    ADR-0016: "created_by as immutable metadata"
    ADR-0024: "Artifact self-handled access control"

  explorations:
    access_control: "Full reasoning for ADR-0024"
    resolved_questions: "Historical Q&A from model development"
    escrow_stress_test: "Insights from escrow walkthrough"
    ostrom_rights_mapping: "Mapping to Ostrom's rights framework"

  code_gaps:
    subscribe_permission: "Needs read check"
    invariants: "Plan #231"
