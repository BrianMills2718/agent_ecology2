# Doc-Code Coupling Map
#
# Defines which docs must be reviewed when source files change.
# CI will fail on strict couplings, warn on soft couplings.
#
# Format:
#   - sources: [glob patterns for source files]
#     docs: [paths to docs that should be updated]
#     description: what this coupling represents
#     soft: true  # DEPRECATED - see below
#
# ============================================================================
# WARNING: The `soft: true` flag is DEPRECATED
# ============================================================================
# Soft couplings allow documentation drift to accumulate silently.
#
# Behavior depends on meta-process.yaml configuration:
#   - strict_doc_coupling: true (default) - ALL couplings are strict
#   - strict_doc_coupling: false - soft couplings warn instead of fail
#
# Prefer removing `soft: true` and making all couplings strict.
# If you must add soft coupling, document WHY in the coupling definition.
# ============================================================================

couplings:
  # ===========================================================================
  # STRICT COUPLINGS (CI fails if violated)
  # ===========================================================================

  # Core execution model
  - sources:
      - "src/simulation/runner.py"
      - "src/world/world.py"
    docs:
      - "docs/architecture/current/execution_model.md"
    description: "Tick loop and two-phase execution"

  # Resource accounting
  - sources:
      - "src/world/ledger.py"
      - "src/world/simulation_engine.py"
    docs:
      - "docs/architecture/current/resources.md"
    description: "Flow/stock resources, scrip, budget tracking"

  # Genesis artifacts
  - sources:
      - "src/world/genesis.py"
      - "src/world/mcp_bridge.py"
    docs:
      - "docs/architecture/current/genesis_artifacts.md"
    description: "System services (ledger, oracle, escrow, MCP bridges)"

  # Agent system
  - sources:
      - "src/agents/agent.py"
      - "src/agents/memory.py"
      - "src/agents/loader.py"
    docs:
      - "docs/architecture/current/agents.md"
    description: "Agent lifecycle, thinking, memory"

  # Artifacts and execution
  - sources:
      - "src/world/artifacts.py"
      - "src/world/executor.py"
      - "src/world/action_executor.py"
      - "src/world/permission_checker.py"
      - "src/world/interface_validation.py"
      - "src/world/actions.py"
    docs:
      - "docs/architecture/current/artifacts_executor.md"
    description: "Artifact storage, policies, code execution, permission checking, interface validation"

  # Configuration
  - sources:
      - "src/config.py"
      - "src/config_schema.py"
    docs:
      - "docs/architecture/current/configuration.md"
    description: "Config loading and validation"

  # Supporting systems
  - sources:
      - "src/simulation/checkpoint.py"
      - "src/world/logger.py"
      - "src/dashboard/*.py"
    docs:
      - "docs/architecture/current/supporting_systems.md"
    description: "Checkpoint, logging, dashboard"

  # CI itself
  - sources:
      - ".github/workflows/ci.yml"
      - "scripts/check_doc_coupling.py"
      - "scripts/doc_coupling.yaml"
    docs:
      - "docs/architecture/current/ci.md"
    description: "CI pipeline"

  # ===========================================================================
  # SOFT COUPLINGS (DEPRECATED - see header warning)
  # ===========================================================================
  # These are treated as STRICT by default (meta-process.yaml: strict_doc_coupling: true)
  # The `soft: true` flag only takes effect when strict_doc_coupling: false
  #
  # NOTE: Plan file â†’ CLAUDE.md strict coupling REMOVED to prevent PR conflicts.
  # The plan index (docs/plans/CLAUDE.md) is now auto-generated by post-merge CI.
  # See: .github/workflows/ci.yml post-merge job runs sync_plan_status.py --sync

  # When current/ docs change, consider if a gap was closed
  - sources:
      - "docs/architecture/current/*.md"
    docs:
      - "docs/plans/CLAUDE.md"
    description: "Gap closure tracking - update plan status if gap closed"
    soft: true

  # When implementing token bucket, update its plan
  - sources:
      - "src/world/rate_tracker.py"
    docs:
      - "docs/plans/01_rate_allocation.md"
    description: "Token bucket implementation - update plan status"
    soft: true

  # When implementing continuous execution, update its plan
  - sources:
      - "src/simulation/continuous_runner.py"
    docs:
      - "docs/plans/02_continuous_execution.md"
    description: "Continuous execution - update plan status"
    soft: true

  # Terminology changes affect multiple docs
  - sources:
      - "src/world/ledger.py"
      - "src/config_schema.py"
    docs:
      - "docs/GLOSSARY.md"
    description: "Terminology - new terms or renamed concepts?"
    soft: true

  # Dashboard frontend changes
  - sources:
      - "src/dashboard/static/js/**/*.js"
      - "src/dashboard/static/css/**/*.css"
    docs:
      - "docs/architecture/current/supporting_systems.md"
    description: "Dashboard UI changes - document new panels/features"
    soft: true

  # Agent models and schemas
  - sources:
      - "src/agents/models.py"
      - "src/agents/schema.py"
    docs:
      - "docs/architecture/current/agents.md"
    description: "Agent response models - update if new fields added"
    soft: true

  # NOTE: Plan-to-index coupling removed entirely - CLAUDE.md is auto-generated
