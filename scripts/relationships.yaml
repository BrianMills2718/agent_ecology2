# Unified Documentation Graph
# ============================
# Single source of truth for all documentation relationships.
# Replaces: governance.yaml, doc_coupling.yaml
#
# Usage:
#   python scripts/sync_governance.py --check    # Check ADR headers
#   python scripts/check_doc_coupling.py --check # Check doc-code coupling
#   python scripts/validate_plan.py --plan N     # Query graph before implementing
#
# Edge types:
#   governs:       ADR governs code (embeds headers in source)
#   documented_by: Source documented by architecture doc (CI enforcement)
#   affects:       Source changes may affect this doc (warnings)

version: 1

# =============================================================================
# ADR DEFINITIONS
# =============================================================================
# Referenced by governance edges. Maps ADR number to file info.

adrs:
  1:
    title: "Everything is an artifact"
    file: "0001-everything-is-artifact.md"
  2:
    title: "No compute debt"
    file: "0002-no-compute-debt.md"
  3:
    title: "Contracts can do anything"
    file: "0003-contracts-can-do-anything.md"

# =============================================================================
# GOVERNANCE: ADR -> Source
# =============================================================================
# These define which ADRs govern which source files.
# sync_governance.py uses these to embed headers in source files.

governance:
  - source: src/world/contracts.py
    adrs: [1, 3]
    context: |
      Permission checks are the hot path - keep them fast.
      Contracts return decisions; kernel applies state changes.

  - source: src/world/genesis_contracts.py
    adrs: [1, 3]
    context: |
      Four built-in contracts: freeware, self_owned, private, public.
      These are Python classes, not artifacts (current implementation).

  - source: src/world/ledger.py
    adrs: [1, 2]
    context: |
      All balance mutations go through here.
      Never allow negative balances - fail loud.

  - source: src/world/artifacts.py
    adrs: [1]
    context: |
      Core artifact storage and management.
      Everything is an artifact - agents, contracts, data.

  - source: src/world/genesis/factory.py
    adrs: [1, 3]
    context: |
      Genesis artifacts: ledger, mint, escrow, event_log, rights_registry, store.
      System-provided, solve cold-start problem. Split into package (Plan #66).

# =============================================================================
# DOC-CODE COUPLINGS: Source -> Doc
# =============================================================================
# These define which docs must be updated when source files change.
# check_doc_coupling.py uses these for CI enforcement.
#
# soft: true means warning-only (unless strict_doc_coupling: true in meta-process.yaml)

couplings:
  # ---------------------------------------------------------------------------
  # STRICT COUPLINGS (CI fails if violated)
  # ---------------------------------------------------------------------------

  # Core execution model
  - sources:
      - src/simulation/runner.py
      - src/world/world.py
    docs:
      - docs/architecture/current/execution_model.md
    description: "Tick loop and two-phase execution"

  # Resource accounting
  - sources:
      - src/world/ledger.py
      - src/world/simulation_engine.py
    docs:
      - docs/architecture/current/resources.md
    description: "Flow/stock resources, scrip, budget tracking"

  # Genesis artifacts
  - sources:
      - src/world/genesis.py
      - src/world/mcp_bridge.py
    docs:
      - docs/architecture/current/genesis_artifacts.md
    description: "System services (ledger, oracle, escrow, MCP bridges)"

  # Agent system
  - sources:
      - src/agents/agent.py
      - src/agents/memory.py
      - src/agents/loader.py
    docs:
      - docs/architecture/current/agents.md
    description: "Agent lifecycle, thinking, memory"

  # Artifacts and execution
  - sources:
      - src/world/artifacts.py
      - src/world/executor.py
      - src/world/action_executor.py
      - src/world/permission_checker.py
      - src/world/interface_validation.py
      - src/world/invoke_handler.py
      - src/world/actions.py
    docs:
      - docs/architecture/current/artifacts_executor.md
    description: "Artifact storage, policies, code execution, permission checking"

  # Configuration
  - sources:
      - src/config.py
      - src/config_schema.py
    docs:
      - docs/architecture/current/configuration.md
    description: "Config loading and validation"

  # Supporting systems
  - sources:
      - src/simulation/checkpoint.py
      - src/world/logger.py
      - src/dashboard/*.py
    docs:
      - docs/architecture/current/supporting_systems.md
    description: "Checkpoint, logging, dashboard"

  # CI itself
  - sources:
      - .github/workflows/ci.yml
      - scripts/check_doc_coupling.py
      - scripts/doc_coupling.yaml
      - scripts/relationships.yaml
    docs:
      - docs/architecture/current/ci.md
    description: "CI pipeline"

  # ---------------------------------------------------------------------------
  # SOFT COUPLINGS (warning-only unless strict_doc_coupling: true)
  # ---------------------------------------------------------------------------

  # Gap closure tracking (excludes ci.md — CI docs don't close plans)
  - sources:
      - docs/architecture/current/execution_model.md
      - docs/architecture/current/agents.md
      - docs/architecture/current/resources.md
      - docs/architecture/current/genesis_artifacts.md
      - docs/architecture/current/artifacts_executor.md
      - docs/architecture/current/configuration.md
      - docs/architecture/current/supporting_systems.md
      - docs/architecture/current/agent_cognition.md
      - docs/architecture/current/contracts.md
      - docs/architecture/current/mint.md
      - docs/architecture/current/coordination_patterns.md
      - docs/architecture/current/genesis_agents.md
      - docs/architecture/current/running.md
    docs:
      - docs/plans/CLAUDE.md
    description: "Gap closure tracking - update plan status if gap closed"
    soft: true

  # Terminology changes
  - sources:
      - src/world/ledger.py
      - src/config_schema.py
    docs:
      - docs/GLOSSARY.md
    description: "Terminology - new terms or renamed concepts?"
    soft: true

  # Dashboard UI
  - sources:
      - src/dashboard/static/js/**/*.js
      - src/dashboard/static/css/**/*.css
    docs:
      - docs/architecture/current/supporting_systems.md
    description: "Dashboard UI changes - document new panels/features"
    soft: true

  # Agent models
  - sources:
      - src/agents/models.py
      - src/agents/schema.py
    docs:
      - docs/architecture/current/agents.md
    description: "Agent response models - update if new fields added"
    soft: true

  # Conceptual model (CMF + CM)
  - sources:
      - src/world/artifacts.py
      - src/world/actions.py
      - src/world/kernel_interface.py
    docs:
      - docs/CONCEPTUAL_MODEL_FULL.yaml
      - docs/CONCEPTUAL_MODEL.yaml
    description: "Conceptual model - artifact fields, actions, kernel interface"

  # Permission system in conceptual model
  - sources:
      - src/world/permission_checker.py
      - src/world/contracts.py
      - src/world/genesis_contracts.py
    docs:
      - docs/CONCEPTUAL_MODEL_FULL.yaml
    description: "Permission system documented in conceptual model"
    soft: true

  # Ledger/resources in conceptual model
  - sources:
      - src/world/ledger.py
      - src/world/rate_tracker.py
    docs:
      - docs/CONCEPTUAL_MODEL_FULL.yaml
    description: "Resource types and scrip documented in conceptual model"
    soft: true

  # Agent cognitive architecture
  - sources:
      - src/agents/agent.py
      - src/agents/workflow.py
      - src/agents/state_machine.py
      - src/agents/memory.py
      - src/agents/reflex.py
    docs:
      - docs/architecture/current/agent_cognition.md
    description: "Agent decision-making, state machine, memory, workflow"

  # Contract system
  - sources:
      - src/world/contracts.py
      - src/world/genesis_contracts.py
      - src/world/permission_checker.py
    docs:
      - docs/architecture/current/contracts.md
    description: "Contract types, permission checking, genesis contracts"

  # Mint system
  - sources:
      - src/world/genesis/mint.py
      - src/world/mint_scorer.py
      - src/world/mint_auction.py
    docs:
      - docs/architecture/current/mint.md
    description: "Mint auction, scoring, genesis mint"

  # Coordination patterns
  - sources:
      - src/world/genesis/escrow.py
      - src/world/artifacts.py
      - src/world/executor.py
      - src/world/kernel_interface.py
    docs:
      - docs/architecture/current/coordination_patterns.md
    description: "Coordination patterns using escrow, artifacts, kernel interface"
    soft: true

  # Genesis agents
  - sources:
      - src/agents/loader.py
      - src/agents/agent.py
    docs:
      - docs/architecture/current/genesis_agents.md
    description: "Agent loading and genesis agent configuration"
    soft: true

  # Running guide
  - sources:
      - src/simulation/runner.py
      - src/simulation/checkpoint.py
      - src/config.py
      - src/dashboard/server.py
    docs:
      - docs/architecture/current/running.md
    description: "Simulation runner, checkpoint, config, dashboard"
    soft: true

  # Security model
  - sources:
      - src/world/executor.py
      - src/simulation/runner.py
    docs:
      - docs/SECURITY.md
    description: "Executor security model, runner budget enforcement"
    soft: true

# =============================================================================
# ORPHAN DOC DETECTION
# =============================================================================
# Docs in these directories are checked against the coupling graph.
# Any doc not referenced in a coupling entry above → warning.

orphan_detection:
  scan_directories:
    - docs/architecture/current
    - docs/architecture/target
  scan_files:
    - docs/CONCEPTUAL_MODEL.yaml
    - docs/CONCEPTUAL_MODEL_FULL.yaml
    - docs/GLOSSARY.md
    - docs/SECURITY.md
    - docs/DESIGN_CLARIFICATIONS.md
    - docs/SCHEMA_AUDIT.md
  exempt_paths:
    - docs/plans/          # Plans have their own tracking
    - docs/archive/        # Archived docs are intentionally uncoupled
    - docs/adr/            # ADRs use governance edges, not couplings
    - docs/CLAUDE.md       # Meta-docs
    - docs/SIMULATION_LEARNINGS.md  # Observational notes
    - docs/architecture/current/CLAUDE.md   # Directory meta-doc
    - docs/architecture/current/README.md   # Directory index
    - docs/architecture/target/             # Aspirational docs (not code-coupled)
    - docs/DESIGN_CLARIFICATIONS.md        # Design rationale archive (not code-coupled)
    - docs/SCHEMA_AUDIT.md                 # Historical audit report (not code-coupled)
