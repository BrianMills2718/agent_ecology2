# Unified Documentation Graph
# ============================
# Single source of truth for all documentation relationships.
# Replaces: governance.yaml, doc_coupling.yaml
#
# Usage:
#   python scripts/sync_governance.py --check    # Check ADR headers
#   python scripts/check_doc_coupling.py --check # Check doc-code coupling
#   python scripts/validate_plan.py --plan N     # Query graph before implementing
#
# Edge types:
#   governs:       ADR governs code (embeds headers in source)
#   documented_by: Source documented by architecture doc (CI enforcement)
#   affects:       Source changes may affect this doc (warnings)

version: 1

# =============================================================================
# ADR DEFINITIONS
# =============================================================================
# Referenced by governance edges. Maps ADR number to file info.

adrs:
  1:
    title: "Everything is an artifact"
    file: "0001-everything-is-artifact.md"
  2:
    title: "No compute debt"
    file: "0002-no-compute-debt.md"
  3:
    title: "Contracts can do anything"
    file: "0003-contracts-can-do-anything.md"
  4:
    title: "Mint as system primitive"
    file: "0004-mint-system-primitive.md"
  7:
    title: "Single ID namespace"
    file: "0007-single-id-namespace.md"
  8:
    title: "Token bucket rate limiting"
    file: "0008-token-bucket-rate-limiting.md"
  9:
    title: "Memory as artifact"
    file: "0009-memory-as-artifact.md"
  10:
    title: "Continuous agent loops"
    file: "0010-continuous-agent-loops.md"
  11:
    title: "Standing pays costs"
    file: "0011-standing-pays-costs.md"
  12:
    title: "Scrip non-negative"
    file: "0012-scrip-non-negative.md"
  13:
    title: "Configurable agent workflows"
    file: "0013-configurable-agent-workflows.md"
  14:
    title: "Continuous execution primary"
    file: "0014-continuous-execution-primary.md"
  15:
    title: "Contracts as artifacts"
    file: "0015-contracts-as-artifacts.md"
  16:
    title: "created_by replaces owner_id"
    file: "0016-created-by-not-owner.md"
  17:
    title: "Dangling contracts fail open"
    file: "0017-dangling-contracts-fail-open.md"
  19:
    title: "Unified permission architecture"
    file: "0019-unified-permission-architecture.md"
  20:
    title: "Event schema contract"
    file: "0020-event-schema-contract.md"
  21:
    title: "Executor design principles"
    file: "0021-executor-design-principles.md"
  23:
    title: "Resource attribution"
    file: "0023-resource-attribution.md"
  24:
    title: "Artifact self-handled access"
    file: "0024-artifact-self-handled-access.md"
  26:
    title: "Sophisticated initial agents"
    file: "0026-sophisticated-initial-agents.md"

# =============================================================================
# GOVERNANCE: ADR -> Source
# =============================================================================
# These define which ADRs govern which source files.
# sync_governance.py uses these to embed headers in source files.
#
# Plan #291: Systematic documentation linking - comprehensive ADR coverage

governance:
  # ===========================================================================
  # WORLD MODULE - Core Kernel Infrastructure
  # ===========================================================================

  - source: src/world/world.py
    adrs: [1, 7, 17, 20, 23]
    context: |
      Central kernel coordinating all state. Single ID namespace (ADR-0007).
      Bootstrap phase creates genesis artifacts (ADR-0017).
      Emits events per ADR-0020, tracks billing_principal per ADR-0023.

  - source: src/world/artifacts.py
    adrs: [1, 7, 11, 16]
    context: |
      Core artifact storage. Everything is an artifact (ADR-0001).
      Single ID namespace, reserved namespaces (ADR-0007).
      Use 'created_by' not 'owner' (ADR-0016).
      'has_standing' determines principal status (ADR-0011).

  - source: src/world/ledger.py
    adrs: [1, 2, 11, 12]
    context: |
      All balance mutations go through here (ADR-0001).
      No compute debt - charge before execution (ADR-0002).
      Never allow negative balances - fail loud (ADR-0012).
      Only principals (has_standing) can hold resources (ADR-0011).

  - source: src/world/contracts.py
    adrs: [1, 3, 15, 16, 19]
    context: |
      Permission checks are the hot path - keep them fast.
      Contracts return decisions; kernel applies state changes (ADR-0003).
      Use 'created_by' in context, not 'owner' (ADR-0016).
      Contracts are artifacts (ADR-0015).
      Unified permission architecture (ADR-0019).

  - source: src/world/kernel_contracts.py
    adrs: [1, 3, 15, 16, 17, 19]
    context: |
      Five built-in contracts: freeware, transferable_freeware, self_owned, private, public.
      Use 'created_by' in permission checks (ADR-0016).
      Dangling contracts fail open (ADR-0017).
      Cold-start convenience, not kernel privilege (ADR-0017).

  - source: src/world/permission_checker.py
    adrs: [1, 3, 17, 19]
    context: |
      Unified permission architecture (ADR-0019).
      Contracts decide permissions (ADR-0003).
      Dangling contract fallback to configurable default (ADR-0017).
      Minimal kernel context: caller, action, target, target_created_by.

  - source: src/world/executor.py
    adrs: [1, 2, 11, 14, 21, 23]
    context: |
      SafeExecutor for sandboxed code execution.
      No compute debt - validate before execution (ADR-0002).
      Charges costs to principals (ADR-0011, ADR-0023).
      Follow executor design principles (ADR-0021).
      Continuous execution context (ADR-0014).

  - source: src/world/action_executor.py
    adrs: [1, 2, 11, 19, 21, 23, 24]
    context: |
      Executes action intents. No compute debt (ADR-0002).
      Permission checking via contracts (ADR-0019).
      Charges costs to principals (ADR-0011, ADR-0023).
      Supports handle_request for self-handled access (ADR-0024).
      Safe executor patterns (ADR-0021).

  - source: src/world/invoke_handler.py
    adrs: [1, 19, 21]
    context: |
      Artifact-to-artifact invocation.
      Immediate caller model - B's contract checks A can invoke B (ADR-0019).
      Safe invoke patterns (ADR-0021).

  - source: src/world/actions.py
    adrs: [1, 19, 20]
    context: |
      Five kernel actions: read, write, edit, invoke, delete (ADR-0019).
      ActionResult with resource tracking per event schema (ADR-0020).

  - source: src/world/kernel_interface.py
    adrs: [1, 14, 19, 24]
    context: |
      KernelState/KernelActions for artifact sandbox.
      Equal access for all artifacts - no genesis privilege.
      Verified caller_id for self-handled access (ADR-0024).
      Continuous execution context (ADR-0014).

  - source: src/world/rate_tracker.py
    adrs: [8, 10, 14]
    context: |
      Token bucket rate limiting for flow resources (ADR-0008).
      Gates continuous execution loops (ADR-0010, ADR-0014).
      Rolling window - independent of simulation ticks.

  - source: src/world/resource_manager.py
    adrs: [2, 11, 12, 20, 23]
    context: |
      Unified resource management.
      No compute debt - check before consumption (ADR-0002).
      Principals (has_standing) hold resources (ADR-0011).
      Non-negative balances (ADR-0012).
      Resource events per ADR-0020, billing_principal per ADR-0023.

  - source: src/world/delegation.py
    adrs: [7, 16, 19, 23]
    context: |
      Charge delegation with deterministic IDs (ADR-0007).
      Uses created_by for payer validation (ADR-0016).
      Contract-based authorization (ADR-0019).
      Resource attribution for delegated costs (ADR-0023).

  - source: src/world/id_registry.py
    adrs: [7]
    context: |
      Single ID namespace - no collisions across entity types (ADR-0007).

  - source: src/world/interface_validation.py
    adrs: [14, 21]
    context: |
      Validates arguments before artifact execution (ADR-0021).
      Supports continuous execution model (ADR-0014).

  - source: src/world/simulation_engine.py
    adrs: [2, 14]
    context: |
      Resource measurement independent of execution model.
      No compute debt - charge real resources (ADR-0002).
      Supports continuous execution (ADR-0014).

  - source: src/world/logger.py
    adrs: [20]
    context: |
      Event schema contract (ADR-0020).
      Monotonic sequence counter, ISO 8601 timestamps.
      Resource events: consumed, allocated, spent.

  - source: src/world/triggers.py
    adrs: [20]
    context: |
      Event-driven triggers filter on typed events (ADR-0020).

  # Plan #293: Additional world module governance
  - source: src/world/kernel_queries.py
    adrs: [19, 20]
    context: |
      Read-only kernel state queries for query_kernel action (Plan #184).
      Permission-aware queries (ADR-0019).
      Returns typed events per schema (ADR-0020).

  - source: src/world/mcp_bridge.py
    adrs: [1, 14]
    context: |
      MCP server integration for external tool access.
      Tools exposed as artifacts (ADR-0001).
      Integrates with continuous execution (ADR-0014).

  - source: src/world/model_access.py
    adrs: [2, 11, 23]
    context: |
      Per-agent model access quotas (Plan #113).
      No compute debt - check quota before call (ADR-0002).
      Principals hold quotas (ADR-0011).
      Resource attribution for model usage (ADR-0023).

  - source: src/world/usage_tracker.py
    adrs: [20, 23]
    context: |
      LLM usage tracking per model (Plan #166).
      Emits usage events per schema (ADR-0020).
      Resource attribution for billing (ADR-0023).

  - source: src/world/resource_metrics.py
    adrs: [20]
    context: |
      Read-only resource metrics aggregation (Plan #93).
      Metrics follow event schema (ADR-0020).

  # ===========================================================================
  # MINT MODULE
  # ===========================================================================

  - source: src/world/mint_auction.py
    adrs: [1, 4, 11, 12]
    context: |
      Mint as system primitive (ADR-0004).
      Bid escrow holds real scrip (ADR-0011, ADR-0012).
      Mint is artifact (ADR-0001).

  - source: src/world/mint_scorer.py
    adrs: [4]
    context: |
      Mint scoring for task evaluation (ADR-0004).

  - source: src/world/mint_task_manager.py
    adrs: [4]
    context: |
      Task-based minting (ADR-0004).

  - source: src/world/mint_tasks.py
    adrs: [4]
    context: |
      Task-based mint system with verifiable tasks (Plan #269).
      Tasks define public/hidden tests for objective scoring (ADR-0004).

  # ===========================================================================
  # AGENTS MODULE
  # ===========================================================================

  - source: src/agents/agent.py
    adrs: [1, 9, 10, 13, 14, 26]
    context: |
      Agents are artifacts (ADR-0001).
      Working memory injection from memory artifact (ADR-0009).
      Continuous agent loops (ADR-0010).
      Configurable workflows (ADR-0013).
      Continuous execution primary model (ADR-0014).
      Sophisticated initial agents with rich context (ADR-0026).

  - source: src/agents/memory.py
    adrs: [1, 9]
    context: |
      Agent memory stored as artifacts (ADR-0009).
      Memory is observable, tradeable artifact (ADR-0001).

  - source: src/agents/workflow.py
    adrs: [13, 14, 26]
    context: |
      Configurable agent workflows (ADR-0013).
      Integrates with continuous execution loops (ADR-0014).
      Multi-step workflows for sophisticated agents (ADR-0026).

  - source: src/agents/loader.py
    adrs: [1, 9, 10, 26]
    context: |
      Loads agents from artifact store (ADR-0001).
      Links agents to memory artifacts (ADR-0009).
      Creates agent loops (ADR-0010).
      Loads sophisticated agent configurations (ADR-0026).

  - source: src/agents/state_store.py
    adrs: [9]
    context: |
      Agent state persistence (separate from memory artifacts).
      Memory persists via artifact store (ADR-0009).

  - source: src/agents/reflex.py
    adrs: [13, 14]
    context: |
      Reflex-based quick responses in workflow (ADR-0013).
      Supports continuous execution (ADR-0014).

  - source: src/agents/state_machine.py
    adrs: [13, 14]
    context: |
      Agent state machine for workflow (ADR-0013).
      Continuous execution model (ADR-0014).

  - source: src/agents/models.py
    adrs: [1]
    context: |
      Agent response models as artifact content (ADR-0001).

  - source: src/agents/schema.py
    adrs: [1]
    context: |
      Action schema for agent artifact operations (ADR-0001).

  - source: src/agents/planning.py
    adrs: [9]
    context: |
      Plan artifacts stored as artifact content (ADR-0009).

  # Plan #293: Additional agent module governance
  - source: src/agents/component_loader.py
    adrs: [13, 26]
    context: |
      Modular prompt component loading (Plan #222).
      Enables configurable agent behaviors (ADR-0013).
      Supports sophisticated agent genotypes (ADR-0026).

  - source: src/agents/hooks.py
    adrs: [13]
    context: |
      Workflow hooks for auto-invocation at timing points.
      Extends configurable workflow system (ADR-0013).

  - source: src/agents/agent_schema.py
    adrs: [13, 26]
    context: |
      Pydantic schema for agent.yaml validation.
      Validates configurable workflow definitions (ADR-0013).
      Enforces sophisticated agent structure (ADR-0026).

  # ===========================================================================
  # SIMULATION MODULE
  # ===========================================================================

  - source: src/simulation/runner.py
    adrs: [1, 10, 14, 17]
    context: |
      Simulation orchestration using continuous model (ADR-0014).
      Creates agent loops (ADR-0010).
      Triggers bootstrap phase (ADR-0017).

  - source: src/simulation/agent_loop.py
    adrs: [8, 10, 14]
    context: |
      Core continuous execution implementation (ADR-0010, ADR-0014).
      AgentLoop._execute_iteration() is primary integration point.
      RateTracker gates resource capacity (ADR-0008).

  - source: src/simulation/artifact_loop.py
    adrs: [10, 14]
    context: |
      Continuous execution for has_loop artifacts (ADR-0010, ADR-0014).
      V4 artifact agents run autonomously.

  - source: src/simulation/checkpoint.py
    adrs: [9]
    context: |
      Checkpoints preserve working memory (ADR-0009).
      Behavioral continuity on resume.

  # Plan #293: Additional simulation module governance
  - source: src/simulation/supervisor.py
    adrs: [10, 14]
    context: |
      AgentSupervisor for crash recovery with backoff.
      Maintains continuous agent loops (ADR-0010, ADR-0014).
      Death classification and auto-restart logic.

  # ===========================================================================
  # DASHBOARD MODULE - Event Consumption
  # ===========================================================================

  - source: src/dashboard/models_v2/events.py
    adrs: [20]
    context: |
      Canonical event type definitions per ADR-0020.
      EventEnvelope, ResourceConsumedEvent, ActionEvent, AgentStateEvent.

  - source: src/dashboard/models_v2/state.py
    adrs: [20]
    context: |
      State models built from events (ADR-0020).
      ResourceUsage, AgentState, WorldState.

  - source: src/dashboard/core_v2/event_parser.py
    adrs: [20]
    context: |
      Parses JSONL event stream into typed events (ADR-0020).
      Graceful fallback for unknown event types.

  - source: src/dashboard/core_v2/state_tracker.py
    adrs: [20]
    context: |
      Reconstructs world state from event stream (ADR-0020).
      Uses sequence number for event ordering.

  - source: src/dashboard/core_v2/metrics_engine.py
    adrs: [20]
    context: |
      Computes metrics from event-derived state (ADR-0020).

  - source: src/dashboard/parser.py
    adrs: [20]
    context: |
      Legacy event parser (v1) for compatibility (ADR-0020).

  - source: src/dashboard/auditor.py
    adrs: [20]
    context: |
      Health assessment from event stream (ADR-0020).

  # ===========================================================================
  # CONFIGURATION
  # ===========================================================================

  - source: src/config_schema.py
    adrs: [1, 3, 17, 19]
    context: |
      Config validation including contract defaults (ADR-0019).
      default_when_null, default_on_missing settings (ADR-0017).
      Method costs for artifact operations (ADR-0001, ADR-0003).

  # NOTE: src/world/genesis/factory.py removed in Plan #254
  # Genesis artifacts replaced with kernel primitives (transfer, mint)

# =============================================================================
# ONTOLOGY MAPPINGS (Plan #291, renamed Plan #294)
# =============================================================================
# Maps entities from docs/ONTOLOGY.yaml (formerly CONCEPTUAL_MODEL.yaml) to source files.
# Used by extract_relevant_context.py to inject conceptual context before edits.

conceptual_model:
  artifact:
    description: "The primal entity - any persistent, addressable object"
    source_files:
      - src/world/artifacts.py       # Core dataclass and storage
      - src/world/actions.py         # ActionIntent references artifact_id
    key_fields: [id, type, content, created_by, has_standing, has_loop, access_contract_id]

  actions:
    description: "11 core actions: storage (4), execution (1), value (3), observation (2), signal (2)"
    source_files:
      - src/world/actions.py         # ActionIntent, ActionResult definitions
      - src/world/action_executor.py # Action execution logic
    categories:
      storage: [read_artifact, write_artifact, edit_artifact, delete_artifact]
      execution: [invoke_artifact]
      value: [transfer, mint, submit_to_task]
      observation: [noop, query_kernel]
      signal: [subscribe_artifact, unsubscribe_artifact]

  kernel_interface:
    description: "KernelState (read-only) + KernelActions (write with verified caller)"
    source_files:
      - src/world/kernel_interface.py
    methods:
      kernel_state: 11  # get_balance, get_resource, read_artifact, etc.
      kernel_actions: 15  # transfer_scrip, write_artifact, submit_for_mint, etc.

  permission_system:
    description: "ADR-0019 kernel-mediated contract checking"
    source_files:
      - src/world/contracts.py       # PermissionAction, AccessContract protocol
      - src/world/kernel_contracts.py # Five built-in contracts
      - src/world/permission_checker.py # check_permission_via_contract()
    contracts: [freeware, transferable_freeware, self_owned, private, public]

  resources:
    description: "Three resource types + scrip accounting"
    source_files:
      - src/world/ledger.py          # Scrip balances
      - src/world/rate_tracker.py    # Renewable (token bucket)
      - src/world/resource_manager.py # Unified resource management
    types:
      depletable: "llm_dollars - gone forever"
      allocatable: "disk_bytes - reusable when freed"
      renewable: "llm_calls_per_minute - token bucket rate-limited"

  non_existence:
    description: "Forbidden terminology - these concepts DO NOT EXIST"
    forbidden_terms:
      owner: "Use 'created_by' for creator, 'contract' for access (ADR-0016)"
      owner_id: "Use 'created_by' (ADR-0016)"
      tick_mode: "Removed in Plan #247 - only continuous execution"
      tick_based: "Removed in Plan #247 - only continuous execution"

# =============================================================================
# GLOSSARY MAPPINGS (Plan #291)
# =============================================================================
# Maps terms from docs/GLOSSARY.md to implementing source files.
# Used by extract_relevant_context.py to inject glossary context before edits.

glossary:
  # Core entity terms
  artifact:
    definition: "Any persistent, addressable object"
    source_files: [src/world/artifacts.py]
  agent:
    definition: "Artifact with has_standing=True and has_loop=True"
    source_files: [src/agents/agent.py, src/world/artifacts.py]
  principal:
    definition: "Entity that can hold resources (has_standing=True)"
    source_files: [src/world/artifacts.py, src/world/ledger.py]
  contract:
    definition: "Artifact or kernel object governing access permissions"
    source_files: [src/world/contracts.py, src/world/kernel_contracts.py]

  # Property terms
  has_standing:
    definition: "Can hold resources and enter contracts"
    source_files: [src/world/artifacts.py, src/world/ledger.py]
  has_loop:
    definition: "Runs autonomously"
    source_files: [src/world/artifacts.py, src/simulation/artifact_loop.py]
  created_by:
    definition: "Immutable creator identifier (NOT owner)"
    source_files: [src/world/artifacts.py]
  access_contract_id:
    definition: "Reference to governing contract"
    source_files: [src/world/artifacts.py, src/world/permission_checker.py]

  # Resource terms
  scrip:
    definition: "Internal accounting unit"
    source_files: [src/world/ledger.py]
  depletable:
    definition: "Resource gone forever when consumed"
    source_files: [src/world/resource_manager.py]
  allocatable:
    definition: "Resource reusable when freed"
    source_files: [src/world/resource_manager.py]
  renewable:
    definition: "Token bucket rate-limited resource"
    source_files: [src/world/rate_tracker.py]

  # Action terms
  invoke:
    definition: "Execute artifact code or call genesis method"
    source_files: [src/world/action_executor.py, src/world/invoke_handler.py]
  transfer:
    definition: "Move scrip between principals"
    source_files: [src/world/ledger.py, src/world/kernel_interface.py]
  mint:
    definition: "Submit artifact to auction for scrip creation"
    source_files: [src/world/mint_auction.py]
  submit_to_task:
    definition: "Submit artifact to task-based mint"
    source_files: [src/world/mint_task_manager.py]

  # System terms
  kernel:
    definition: "Core system providing storage, identity, physics enforcement"
    source_files: [src/world/world.py, src/world/kernel_interface.py]
  genesis:
    definition: "Pre-seeded artifacts created at world init"
    source_files: [src/world/world.py]
  bootstrap:
    definition: "Instantaneous initialization phase (World.__init__)"
    source_files: [src/world/world.py]

  # Forbidden terms (non_existence)
  owner:
    deprecated: true
    replacement: "created_by"
    reason: "ADR-0016 - owner implies mutable ownership"
  tick:
    deprecated: true
    replacement: "continuous execution"
    reason: "Plan #247 - tick-based mode removed"

# =============================================================================
# DOC-CODE COUPLINGS: Source -> Doc
# =============================================================================
# These define which docs must be updated when source files change.
# check_doc_coupling.py uses these for CI enforcement.
#
# soft: true means warning-only (unless strict_doc_coupling: true in meta-process.yaml)

couplings:
  # ---------------------------------------------------------------------------
  # STRICT COUPLINGS (CI fails if violated)
  # ---------------------------------------------------------------------------

  # Core execution model
  - sources:
      - src/simulation/runner.py
      - src/world/world.py
    docs:
      - docs/architecture/current/execution_model.md
    description: "Execution model and event loop"

  # Resource accounting
  - sources:
      - src/world/ledger.py
      - src/world/simulation_engine.py
    docs:
      - docs/architecture/current/resources.md
    description: "Flow/stock resources, scrip, budget tracking"

  # Pre-seeded artifacts (Plan #254: genesis module removed)
  - sources:
      - src/world/mcp_bridge.py
      - src/world/mint_auction.py
    docs:
      - docs/architecture/current/genesis_artifacts.md
    description: "Pre-seeded artifacts (MCP bridges, mint auction)"

  # Agent system
  - sources:
      - src/agents/agent.py
      - src/agents/memory.py
      - src/agents/loader.py
    docs:
      - docs/architecture/current/agents.md
    description: "Agent lifecycle, thinking, memory"

  # Artifacts and execution
  - sources:
      - src/world/artifacts.py
      - src/world/executor.py
      - src/world/action_executor.py
      - src/world/permission_checker.py
      - src/world/interface_validation.py
      - src/world/invoke_handler.py
      - src/world/actions.py
      - src/world/kernel_interface.py
    docs:
      - docs/architecture/current/artifacts_executor.md
    description: "Artifact storage, policies, code execution, kernel interface, permission checking"

  # Configuration
  - sources:
      - src/config.py
      - src/config_schema.py
    docs:
      - docs/architecture/current/configuration.md
    description: "Config loading and validation"

  # Supporting systems
  - sources:
      - src/simulation/checkpoint.py
      - src/world/logger.py
      - src/dashboard/*.py
    docs:
      - docs/architecture/current/supporting_systems.md
    description: "Checkpoint, logging, dashboard"

  # CI itself
  - sources:
      - .github/workflows/ci.yml
      - scripts/check_doc_coupling.py
      - scripts/doc_coupling.yaml
      - scripts/relationships.yaml
    docs:
      - docs/architecture/current/ci.md
    description: "CI pipeline"

  # ---------------------------------------------------------------------------
  # SOFT COUPLINGS (warning-only unless strict_doc_coupling: true)
  # ---------------------------------------------------------------------------

  # Gap closure tracking (excludes ci.md — CI docs don't close plans)
  - sources:
      - docs/architecture/current/execution_model.md
      - docs/architecture/current/agents.md
      - docs/architecture/current/resources.md
      - docs/architecture/current/genesis_artifacts.md
      - docs/architecture/current/artifacts_executor.md
      - docs/architecture/current/configuration.md
      - docs/architecture/current/supporting_systems.md
      - docs/architecture/current/agent_cognition.md
      - docs/architecture/current/contracts.md
      - docs/architecture/current/mint.md
      - docs/architecture/current/coordination_patterns.md
      - docs/architecture/current/genesis_agents.md
      - docs/architecture/current/running.md
    docs:
      - docs/plans/CLAUDE.md
    description: "Gap closure tracking - update plan status if gap closed"
    soft: true

  # Terminology changes
  - sources:
      - src/world/ledger.py
      - src/config_schema.py
    docs:
      - docs/GLOSSARY.md
    description: "Terminology - new terms or renamed concepts?"
    soft: true

  # Dashboard UI
  - sources:
      - src/dashboard/static/js/**/*.js
      - src/dashboard/static/css/**/*.css
    docs:
      - docs/architecture/current/supporting_systems.md
    description: "Dashboard UI changes - document new panels/features"
    soft: true

  # Agent models
  - sources:
      - src/agents/models.py
      - src/agents/schema.py
    docs:
      - docs/architecture/current/agents.md
    description: "Agent response models - update if new fields added"
    soft: true

  # Conceptual model
  - sources:
      - src/world/artifacts.py
      - src/world/actions.py
      - src/world/kernel_interface.py
    docs:
      - docs/ONTOLOGY.yaml
    description: "Conceptual model - artifact fields, actions, kernel interface"

  # Permission system in conceptual model
  - sources:
      - src/world/permission_checker.py
      - src/world/contracts.py
      - src/world/kernel_contracts.py
    docs:
      - docs/ONTOLOGY.yaml
    description: "Permission system documented in conceptual model"
    soft: true

  # Ledger/resources in conceptual model
  - sources:
      - src/world/ledger.py
      - src/world/rate_tracker.py
    docs:
      - docs/ONTOLOGY.yaml
    description: "Resource types and scrip documented in conceptual model"
    soft: true

  # Agent cognitive architecture
  - sources:
      - src/agents/agent.py
      - src/agents/workflow.py
      - src/agents/state_machine.py
      - src/agents/memory.py
      - src/agents/reflex.py
    docs:
      - docs/architecture/current/agent_cognition.md
    description: "Agent decision-making, state machine, memory, workflow"

  # Contract system
  - sources:
      - src/world/contracts.py
      - src/world/kernel_contracts.py
      - src/world/permission_checker.py
    docs:
      - docs/architecture/current/contracts.md
    description: "Contract types, permission checking, genesis contracts"

  # Mint system (Plan #254: genesis/mint.py removed)
  - sources:
      - src/world/mint_scorer.py
      - src/world/mint_auction.py
    docs:
      - docs/architecture/current/mint.md
    description: "Mint auction, scoring, genesis mint"

  # Coordination patterns (Plan #254: genesis/escrow.py removed)
  - sources:
      - src/world/artifacts.py
      - src/world/executor.py
      - src/world/kernel_interface.py
    docs:
      - docs/architecture/current/coordination_patterns.md
    description: "Coordination patterns using escrow, artifacts, kernel interface"
    soft: true

  # Genesis agents
  - sources:
      - src/agents/loader.py
      - src/agents/agent.py
    docs:
      - docs/architecture/current/genesis_agents.md
    description: "Agent loading and genesis agent configuration"
    soft: true

  # Running guide
  - sources:
      - src/simulation/runner.py
      - src/simulation/checkpoint.py
      - src/config.py
      - src/dashboard/server.py
    docs:
      - docs/architecture/current/running.md
    description: "Simulation runner, checkpoint, config, dashboard"
    soft: true

  # Security model
  - sources:
      - src/world/executor.py
      - src/simulation/runner.py
    docs:
      - docs/SECURITY.md
    description: "Executor security model, runner budget enforcement"
    soft: true

  # ---------------------------------------------------------------------------
  # CORE SYSTEMS OVERVIEW (Plan #284)
  # ---------------------------------------------------------------------------
  # CORE_SYSTEMS.md provides orientation for new sessions.
  # Major changes to core infrastructure should update its health status.

  - sources:
      - src/world/ledger.py
      - src/world/artifacts.py
      - src/world/contracts.py
      - src/world/kernel_interface.py
      - src/world/executor.py
      - src/agents/agent.py
      - src/agents/workflow.py
      - src/simulation/runner.py
      - src/world/logger.py
    docs:
      - docs/architecture/current/CORE_SYSTEMS.md
    description: "Core systems overview - major infrastructure changes need health status update"
    soft: true

# =============================================================================
# DOCUMENT HIERARCHY (Plan #284 - ADR-0005)
# =============================================================================
# Defines the reading order for documentation. Used for orientation guidance.
#
# Layers:
#   1. Orientation - Read first (CLAUDE.md, CORE_SYSTEMS.md)
#   2. Reference - Look up when needed (ONTOLOGY, GLOSSARY, target/)
#   3. Implementation - Detailed current state (current/*.md)
#   4. Code - Source of truth (src/**/*.py)
#
# This is advisory - not CI enforced.

document_hierarchy:
  orientation:
    description: "Read first when joining the project"
    docs:
      - CLAUDE.md
      - docs/architecture/current/CORE_SYSTEMS.md

  reference:
    description: "Look up when needed for definitions and vision"
    docs:
      - docs/ONTOLOGY.yaml
      - docs/GLOSSARY.md
      - docs/architecture/target/

  implementation:
    description: "Detailed current state (coupled to code)"
    docs:
      - docs/architecture/current/

# =============================================================================
# TARGET ↔ CURRENT LINKS (Plan #284 - ADR-0005)
# =============================================================================
# Maps aspirational target docs to their current implementation counterparts.
# Enables tracing: "What does the vision say?" → "What's actually implemented?"

target_current_links:
  - target: docs/architecture/target/01_README.md
    current: docs/architecture/current/README.md
    description: "Architecture overview - vision vs reality"

  - target: docs/architecture/target/02_execution_model.md
    current: docs/architecture/current/execution_model.md
    description: "Execution model - vision vs reality"

  - target: docs/architecture/target/03_agents.md
    current: docs/architecture/current/agents.md
    description: "Agent system - vision vs reality"

  - target: docs/architecture/target/04_resources.md
    current: docs/architecture/current/resources.md
    description: "Resource system - vision vs reality"

  - target: docs/architecture/target/05_contracts.md
    current: docs/architecture/current/contracts.md
    description: "Contract system - vision vs reality"

  - target: docs/architecture/target/06_mint.md
    current: docs/architecture/current/mint.md
    description: "Mint system - vision vs reality"

  - target: docs/architecture/target/08_kernel.md
    current: docs/architecture/current/artifacts_executor.md
    description: "Kernel/executor - vision vs reality"

# =============================================================================
# ORPHAN DOC DETECTION
# =============================================================================
# Docs in these directories are checked against the coupling graph.
# Any doc not referenced in a coupling entry above → warning.

orphan_detection:
  scan_directories:
    - docs/architecture/current
    - docs/architecture/target
  scan_files:
    - docs/ONTOLOGY.yaml
    - docs/GLOSSARY.md
    - docs/SECURITY.md
    - docs/DESIGN_CLARIFICATIONS.md
    - docs/SCHEMA_AUDIT.md
  exempt_paths:
    - docs/plans/          # Plans have their own tracking
    - docs/archive/        # Archived docs are intentionally uncoupled
    - docs/adr/            # ADRs use governance edges, not couplings
    - docs/CLAUDE.md       # Meta-docs
    - docs/SIMULATION_LEARNINGS.md  # Observational notes
    - docs/architecture/current/CLAUDE.md   # Directory meta-doc
    - docs/architecture/current/README.md   # Directory index
    - docs/architecture/target/             # Aspirational docs (not code-coupled)
    - docs/DESIGN_CLARIFICATIONS.md        # Design rationale archive (not code-coupled)
    - docs/SCHEMA_AUDIT.md                 # Historical audit report (not code-coupled)

# =============================================================================
# CLAUDE.MD VALIDATION (Plan #244)
# =============================================================================
# Enforces that code directories have CLAUDE.md files listing their contents.
# Used by scripts/check_claude_md.py

claude_md:
  # Directories exempt from CLAUDE.md requirement
  exempt_dirs:
    # Infrastructure / tooling (directory + all subdirs)
    - ".claude/"                            # Claude Code internal config
    - ".claude/*"
    - ".github/"                            # GitHub config and templates
    - ".github/*"
    - "meta-process/"                       # Portable framework (not project-specific)
    - "meta-process/*"
    - "llm_provider_standalone/"            # Standalone utility
    - "llm_provider_standalone/*"
    - "scripts/dev_scripts/"                # Small dev utilities

    # Asset / build directories
    - "*/static/*"                          # Asset directories
    - "*/static-v2/*"                       # Build output

    # Dashboard internals (described by parent CLAUDE.md)
    - "dashboard-v2/src/"                   # Described by dashboard-v2/CLAUDE.md
    - "dashboard-v2/src/*"
    - "dashboard-v2/public/"                # Static assets
    - "src/dashboard/api/"                  # Described by src/dashboard/CLAUDE.md
    - "src/dashboard/api/*"
    - "src/dashboard/core_v2/"              # Described by src/dashboard/CLAUDE.md
    - "src/dashboard/models_v2/"            # Described by src/dashboard/CLAUDE.md

    # Agent personality directories (config, not code modules)
    - "src/agents/_handbook/"               # Template/reference
    - "src/agents/_template/"               # Agent template
    - "src/agents/alpha*"                   # Agent personality configs
    - "src/agents/beta*"                    # Agent personality configs
    - "src/agents/gamma*"                   # Agent personality configs
    - "src/agents/delta*"                   # Agent personality configs
    - "src/agents/epsilon*"                 # Agent personality configs
    - "src/agents/v4_*"                     # Agent personality configs
    - "src/agents/_components/behaviors/"   # Described by parent CLAUDE.md
    - "src/agents/_components/evaluators/"  # Described by parent CLAUDE.md

    # Docs subdirectories
    - "docs/architecture/gaps/"             # Summary file only
    - "docs/architecture/target/agents/"    # Target/aspirational
    - "docs/explorations/"                  # Exploration notes
    - "docs/simulation_learnings/"          # Single-purpose directory

    # Test subdirectories (described by parent CLAUDE.md)
    - "tests/scripts/"                      # Test helper scripts
    - "tests/unit/dashboard/"               # Test subdirectory

  # Files exempt from coverage requirement (not expected in CLAUDE.md tables)
  exempt_files:
    - "CLAUDE.md"          # Doesn't self-reference
    - ".gitignore"         # Infrastructure, not module content
    - "*.lock"             # Lock files (package-lock.json, etc.)
    - "py.typed"           # PEP 561 marker
    - "CONTEXT.md"         # Ephemeral worktree context
    - "*.svg"              # Static assets
    - "*.css"              # Stylesheets
    - "*.html"             # HTML templates (in asset dirs)

# =============================================================================
# FILE CONTEXT LINKAGE (Plan #294)
# =============================================================================
# Maps source files to governing PRDs, domain models, and ADRs.
# Used by context injection hooks to provide relevant specs during edits.
#
# Format:
#   file_context:
#     src/path/file.py:
#       prd: [domain#capability, ...]
#       domain_model: [domain#concept, ...]
#       adr: [NNNN, ...]
#
#   directory_defaults:
#     src/path/:
#       prd: [domain]
#       domain_model: [domain]
#
# Resolution order:
#   1. Exact file match in file_context
#   2. Most specific directory_defaults match
#   3. Warning if no match

file_context:
  # ==========================================================================
  # WORLD DOMAIN - Core Kernel Infrastructure
  # ==========================================================================
  src/world/artifacts.py:
    prd: [artifacts#persistent-storage, artifacts#universal-addressability, artifacts#metadata-and-typing]
    domain_model: [artifacts#Artifact, artifacts#ArtifactStore, artifacts#ArtifactType, artifacts#Metadata]
    adr: [0001, 0007, 0011, 0016]

  src/world/executor.py:
    prd: [artifacts#execution]
    domain_model: [artifacts#Executable, artifacts#Wallet, artifacts#Interface]
    adr: [0002, 0021, 0023]

  src/world/ledger.py:
    prd: [resources#scarcity-enforcement, resources#resource-tracking, resources#scrip-currency]
    domain_model: [resources#Ledger, resources#Balance, resources#Scrip, resources#Transfer]
    adr: [0002, 0011, 0012]

  src/world/contracts.py:
    prd: [contracts#permission-checking, contracts#flexible-policies, contracts#contract-as-artifact]
    domain_model: [contracts#Contract, contracts#PermissionAction, contracts#PermissionResult, contracts#PermissionContext]
    adr: [0003, 0015, 0019]

  src/world/kernel_contracts.py:
    prd: [contracts#default-behavior, contracts#flexible-policies]
    domain_model: [contracts#GenesisContract, contracts#AccessPolicy]
    adr: [0003, 0015, 0017, 0019]

  src/world/permission_checker.py:
    prd: [contracts#permission-checking]
    domain_model: [contracts#Contract, contracts#PermissionResult, contracts#PermissionContext]
    adr: [0003, 0017, 0019]

  src/world/rate_tracker.py:
    prd: [resources#resource-types, resources#scarcity-enforcement]
    domain_model: [resources#RateLimit, resources#ResourceType]
    adr: [0008]

  src/world/resource_manager.py:
    prd: [resources#resource-tracking, resources#quota-management]
    domain_model: [resources#Resource, resources#Quota, resources#Balance]
    adr: [0002, 0011, 0012, 0023]

  src/world/kernel_interface.py:
    prd: [artifacts#execution, resources#resource-transfer]
    domain_model: [artifacts#Wallet, resources#Transfer]
    adr: [0014, 0019, 0024]

  src/world/action_executor.py:
    prd: [artifacts#execution, contracts#permission-checking]
    domain_model: [artifacts#Executable, contracts#PermissionResult]
    adr: [0002, 0019, 0021, 0024]

  # ==========================================================================
  # AGENTS DOMAIN
  # ==========================================================================
  src/agents/agent.py:
    prd: [agents#long-term-planning, agents#adaptation, agents#self-modification]
    domain_model: [agents#Agent, agents#Goal, agents#TaskQueue, agents#Memory]
    adr: [0009, 0027]

  src/agents/workflow.py:
    prd: [agents#adaptation]
    domain_model: [agents#TaskQueue, agents#Strategy]
    adr: [0013, 0027]

  src/agents/memory.py:
    prd: [agents#adaptation, agents#long-term-planning]
    domain_model: [agents#Memory]
    adr: [0009]

  src/agents/agent_loop.py:
    prd: [agents#long-term-planning]
    domain_model: [agents#Agent, agents#TaskQueue]
    adr: [0010, 0014, 0027]

  src/agents/llm_client.py:
    prd: [agents#adaptation]
    domain_model: [agents#Agent]
    adr: []

  src/agents/prompt_builder.py:
    prd: [agents#ecosystem-awareness, agents#self-modification]
    domain_model: [agents#WorldModel, agents#SelfModel]
    adr: [0027]

# Directory defaults (fallback when file not explicitly listed)
directory_defaults:
  src/agents/:
    prd: [agents]
    domain_model: [agents]
    adr: [0027]

  src/world/:
    prd: [resources, contracts, artifacts]
    domain_model: [resources, contracts, artifacts]
    adr: [0001, 0003, 0011, 0012, 0015, 0016, 0019]

  src/simulation/:
    prd: []  # Simulation is infrastructure, not a domain
    domain_model: []
    adr: [0010, 0014]

  src/dashboard/:
    prd: []  # Dashboard is observability infrastructure
    domain_model: []
    adr: [0020]

# Files explicitly excluded from context injection
file_context_exempt:
  - "src/**/__init__.py"      # Package markers
  - "src/**/conftest.py"      # Test fixtures
  - "tests/**"                # Test files derive from source
