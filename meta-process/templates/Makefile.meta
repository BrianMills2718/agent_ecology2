# === META-PROCESS TARGETS ===
# Added by meta-process install.sh

# Configuration
SCRIPTS_META := scripts/meta
WORKTREE_BASE := ../worktrees
PLANS_DIR := docs/plans

# --- Session Start ---
.PHONY: status claims

status:  ## Show git status + active claims
	@git status --short
	@echo ""
	@python $(SCRIPTS_META)/check_claims.py --list 2>/dev/null || true

claims:  ## List active claims
	@python $(SCRIPTS_META)/check_claims.py --list

# --- Worktree Management ---
.PHONY: worktree worktree-list worktree-remove

worktree:  ## Create worktree (interactive: prompts for branch name)
	@read -p "Branch name (e.g., plan-42-feature): " branch; \
	read -p "Task description: " task; \
	python $(SCRIPTS_META)/check_claims.py --claim --id "$$branch" --task "$$task" && \
	git worktree add "$(WORKTREE_BASE)/$$branch" -b "$$branch" origin/main && \
	echo "" && \
	echo "Worktree created at: $(WORKTREE_BASE)/$$branch" && \
	echo "cd $(WORKTREE_BASE)/$$branch"

worktree-list:  ## List all worktrees
	@git worktree list

worktree-remove:  ## Remove worktree safely (BRANCH=name required)
ifndef BRANCH
	$(error BRANCH is required. Usage: make worktree-remove BRANCH=plan-42-feature)
endif
	@python $(SCRIPTS_META)/safe_worktree_remove.py $(BRANCH)

# --- During Implementation ---
.PHONY: test test-quick check

test:  ## Run pytest
	pytest tests/ -v

test-quick:  ## Run pytest (no traceback)
	pytest tests/ -q --tb=no

check:  ## Run all checks (test, mypy, lint)
	@echo "Running tests..."
	@pytest tests/ -q --tb=short
	@echo ""
	@echo "Running mypy..."
	@mypy src/ --ignore-missing-imports
	@echo ""
	@echo "All checks passed!"

# --- PR Workflow ---
.PHONY: pr-ready pr merge finish

pr-ready:  ## Rebase on main and push
	@git fetch origin main
	@git rebase origin/main
	@git push -u origin HEAD

pr:  ## Create PR (opens browser)
	@gh pr create --fill --web

merge:  ## Merge PR (PR=number required)
ifndef PR
	$(error PR is required. Usage: make merge PR=123)
endif
	@python $(SCRIPTS_META)/merge_pr.py $(PR)

finish:  ## Merge PR + cleanup worktree (BRANCH=name PR=number required)
ifndef BRANCH
	$(error BRANCH is required. Usage: make finish BRANCH=plan-42-feature PR=123)
endif
ifndef PR
	$(error PR is required. Usage: make finish BRANCH=plan-42-feature PR=123)
endif
	@python $(SCRIPTS_META)/finish_pr.py $(PR) $(BRANCH)

# --- Claims ---
.PHONY: claim release

claim:  ## Claim work (TASK="description" required, PLAN=N optional)
ifndef TASK
	$(error TASK is required. Usage: make claim TASK="Fix bug" PLAN=42)
endif
ifdef PLAN
	@python $(SCRIPTS_META)/check_claims.py --claim --plan $(PLAN) --task "$(TASK)"
else
	@python $(SCRIPTS_META)/check_claims.py --claim --task "$(TASK)"
endif

release:  ## Release current claim
	@python $(SCRIPTS_META)/check_claims.py --release

# --- Plans ---
.PHONY: plan-tests plan-complete

plan-tests:  ## Check plan's required tests (PLAN=N required)
ifndef PLAN
	$(error PLAN is required. Usage: make plan-tests PLAN=42)
endif
	@python $(SCRIPTS_META)/check_plan_tests.py --plan $(PLAN)

plan-complete:  ## Mark plan complete with verification (PLAN=N required)
ifndef PLAN
	$(error PLAN is required. Usage: make plan-complete PLAN=42)
endif
	@python $(SCRIPTS_META)/complete_plan.py --plan $(PLAN)

# --- Help ---
.PHONY: help-meta

help-meta:  ## Show meta-process targets
	@echo "Meta-Process Targets:"
	@echo ""
	@echo "  Session:"
	@echo "    status          Show git status + claims"
	@echo "    claims          List active claims"
	@echo ""
	@echo "  Worktrees:"
	@echo "    worktree        Create worktree (interactive)"
	@echo "    worktree-list   List worktrees"
	@echo "    worktree-remove Remove worktree (BRANCH=name)"
	@echo ""
	@echo "  Development:"
	@echo "    test            Run tests"
	@echo "    check           Run all checks"
	@echo ""
	@echo "  PR Workflow:"
	@echo "    pr-ready        Rebase + push"
	@echo "    pr              Create PR"
	@echo "    merge           Merge PR (PR=number)"
	@echo "    finish          Merge + cleanup (BRANCH=name PR=number)"
	@echo ""
	@echo "  Plans:"
	@echo "    plan-tests      Check plan tests (PLAN=N)"
	@echo "    plan-complete   Complete plan (PLAN=N)"
