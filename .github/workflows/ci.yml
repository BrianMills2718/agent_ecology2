name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements.txt

      - name: Run pytest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: pytest tests/ -v --tb=short

  mypy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy

      - name: Run mypy
        run: |
          mypy --strict --ignore-missing-imports --exclude '__pycache__' --no-namespace-packages src/config.py src/world/*.py src/agents/*.py run.py

  doc-coupling:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Check doc-code coupling
        run: python scripts/check_doc_coupling.py --base origin/main --strict

  plan-status-sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check plan status consistency
        run: python scripts/sync_plan_status.py --check

  plan-blockers:
    runs-on: ubuntu-latest
    # Ensures no plan is blocked by an already-completed plan

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check for stale blockers
        run: python scripts/check_plan_blockers.py --strict

  plan-tests:
    runs-on: ubuntu-latest
    # Validates that plans with defined tests have passing tests
    # STRICT: Fails if required tests don't pass

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements.txt

      - name: List plan test status
        run: python scripts/check_plan_tests.py --list

      - name: Check plan tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/check_plan_tests.py --all

  mock-usage:
    runs-on: ubuntu-latest
    # Detect suspicious mock patterns that may hide real failures
    # Uses --strict to fail if mocking internal code without justification

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check for suspicious mock patterns
        run: python scripts/check_mock_usage.py --strict

  governance-sync:
    runs-on: ubuntu-latest
    # Ensures source files have correct governance headers matching governance.yaml

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Check governance headers in sync
        run: python scripts/sync_governance.py --check

  validate-specs:
    runs-on: ubuntu-latest
    # Validates feature specification files meet minimum requirements

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate feature specs
        run: python scripts/validate_spec.py --all

  locked-sections:
    runs-on: ubuntu-latest
    # Detects modifications to locked acceptance criteria (AC-2)
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Check locked sections
        run: python scripts/check_locked_files.py --base origin/main

  feature-coverage:
    runs-on: ubuntu-latest
    # Checks that source files are assigned to features (informational)
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Check feature coverage
        run: python scripts/check_feature_coverage.py --warn-only

  new-code-tests:
    runs-on: ubuntu-latest
    # Ensures new source files have corresponding tests
    # Prevents adding code without tests

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check new files have tests
        run: python scripts/check_new_code_tests.py --base origin/main --strict --suggest

  unplanned-work:
    runs-on: ubuntu-latest
    # Flags PRs containing [Unplanned] commits
    # Does not block, but requires justification in PR description

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for unplanned work
        run: |
          # Check if any commit in PR has [Unplanned]
          UNPLANNED=$(git log origin/main..HEAD --oneline | grep -c '\[Unplanned\]' || true)

          if [ "$UNPLANNED" -gt 0 ]; then
            echo "========================================"
            echo "WARNING: This PR contains unplanned work"
            echo "========================================"
            echo ""
            echo "Commits with [Unplanned]:"
            git log origin/main..HEAD --oneline | grep '\[Unplanned\]'
            echo ""
            echo "Unplanned work bypasses the planning process."
            echo "Before merging, ensure:"
            echo "  1. Tests are added for all new code"
            echo "  2. Documentation is updated"
            echo "  3. PR description explains why this was unplanned"
            echo ""
            echo "Consider creating a plan file (docs/plans/NN_*.md)"
            echo "for substantial work."
            echo ""
            # Don't fail - just warn
          else
            echo "No unplanned work detected."
          fi

  claim-verification:
    runs-on: ubuntu-latest
    # Verifies the PR branch was claimed before work started
    # Prevents duplicate/overlapping work between Claude instances
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Informational initially - will make strict later

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Verify branch was claimed
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Checking claim for branch: $BRANCH"

          # Check if branch appears in claims (active or completed)
          python -c "
          import yaml
          from pathlib import Path

          yaml_path = Path('.claude/active-work.yaml')
          if not yaml_path.exists():
              print('No claims file found - skipping check')
              exit(0)

          data = yaml.safe_load(yaml_path.read_text()) or {}
          claims = data.get('claims', [])
          completed = data.get('completed', [])

          branch = '$BRANCH'

          # Check active claims
          for c in claims:
              if c.get('cc_id') == branch:
                  scope_parts = []
                  if c.get('plan'):
                      scope_parts.append(f'Plan #{c[\"plan\"]}')
                  if c.get('feature'):
                      scope_parts.append(f'Feature: {c[\"feature\"]}')
                  scope = ' + '.join(scope_parts) if scope_parts else 'unscoped'
                  print(f'✓ Active claim found: {scope}')
                  print(f'  Task: {c.get(\"task\", \"\")}')
                  exit(0)

          # Check completed claims
          for c in completed:
              if c.get('cc_id') == branch:
                  print(f'✓ Completed claim found: {c.get(\"task\", \"\")}')
                  exit(0)

          print(f'⚠️ No claim found for branch: {branch}')
          print()
          print('Work should be claimed with a scope before starting:')
          print('  python scripts/check_claims.py --claim --feature NAME --task \"Your task\"')
          print('  python scripts/check_claims.py --list-features  # See available features')
          exit(1)
          " || {
            echo ""
            echo "========================================"
            echo "WARNING: No claim found for this branch"
            echo "========================================"
            echo ""
            echo "The claim system ensures coordination between"
            echo "Claude instances to prevent duplicate work."
            echo ""
            # Exit 0 for now (informational) - will be exit 1 when strict
            exit 0
          }
