name: CI

on:
  pull_request:
    branches: [main]
  # Only run post-merge on main (lightweight check only)
  push:
    branches: [main]

# Permissions needed for dorny/paths-filter and other actions
permissions:
  contents: read
  pull-requests: read

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Change Detection - Determines which jobs need to run
  # Saves minutes by skipping expensive jobs for docs-only changes
  # =============================================================================
  changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'tests/**'
              - 'run.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
            docs:
              - 'docs/**'
              - '*.md'
              - 'scripts/**'
              - '.claude/**'

  # =============================================================================
  # Core Quality Gates (test + mypy) - Only on code changes
  # =============================================================================
  test:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements.txt

      - name: Run pytest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: pytest tests/ -v --tb=short

  mypy:
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy

      - name: Run mypy
        run: |
          mypy --strict --ignore-missing-imports --exclude '__pycache__' --no-namespace-packages src/config.py src/world/*.py src/agents/*.py run.py

  # =============================================================================
  # Fast Checks - Consolidated into single job (saves ~4 min setup time)
  # Combines: docs, code-quality, meta checks
  # =============================================================================
  fast-checks:
    needs: changes
    if: always() && github.event_name == 'pull_request' && !cancelled()
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: pip install pyyaml

      # --- Doc checks ---
      - name: Check doc-code coupling
        run: python scripts/check_doc_coupling.py --base origin/main --strict

      - name: Check governance headers in sync
        run: python scripts/sync_governance.py --check

      # --- Code quality checks ---
      - name: Check for suspicious mock patterns
        run: python scripts/check_mock_usage.py --strict

      - name: Check new files have tests
        run: python scripts/check_new_code_tests.py --base origin/main --strict --suggest

      - name: Check feature coverage
        continue-on-error: true
        run: python scripts/check_feature_coverage.py --warn-only

      # --- Meta checks ---
      - name: Check locked sections
        run: python scripts/check_locked_files.py --base origin/main

      - name: Validate feature specs
        run: python scripts/validate_spec.py --all

      - name: Verify branch was claimed
        continue-on-error: true
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Checking claim for branch: $BRANCH"
          python -c "
          import yaml
          from pathlib import Path
          yaml_path = Path('.claude/active-work.yaml')
          if not yaml_path.exists():
              print('No claims file found - skipping check')
              exit(0)
          data = yaml.safe_load(yaml_path.read_text()) or {}
          claims = data.get('claims', [])
          completed = data.get('completed', [])
          branch = '$BRANCH'
          for c in claims:
              if c.get('cc_id') == branch:
                  print(f'✓ Active claim found')
                  exit(0)
          for c in completed:
              if c.get('cc_id') == branch:
                  print(f'✓ Completed claim found')
                  exit(0)
          print(f'⚠️ No claim found for branch: {branch}')
          exit(1)
          " || echo 'WARNING: No claim found (non-blocking)'

      - name: Check for human review requirements
        continue-on-error: true
        run: |
          PLANS=$(git log origin/main..HEAD --oneline | grep -oP '\[Plan #\K\d+' | sort -u || true)
          if [ -z "$PLANS" ]; then exit 0; fi
          for plan in $PLANS; do
            PLAN_FILE=$(ls docs/plans/${plan}_*.md 2>/dev/null || ls docs/plans/0${plan}_*.md 2>/dev/null || echo "")
            if [ -n "$PLAN_FILE" ] && grep -q "## Human Review Required" "$PLAN_FILE"; then
              echo "⚠️ Plan #$plan requires human review!"
            fi
          done

      - name: Check ADR requirements
        continue-on-error: true
        run: python scripts/check_adr_requirement.py --base origin/main

  # =============================================================================
  # Plan Checks - Runs for all PRs
  # =============================================================================
  plans:
    needs: changes
    if: always() && github.event_name == 'pull_request' && !cancelled()
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements.txt

      - name: Check plan status consistency
        run: python scripts/sync_plan_status.py --check

      - name: Check for stale blockers
        run: python scripts/check_plan_blockers.py --strict

      - name: Check plan tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/check_plan_tests.py --all --strict

      - name: Verify plan references in commits
        run: |
          UNPLANNED=$(git log origin/main..HEAD --oneline | grep -c '\[Unplanned\]' || true)
          if [ "$UNPLANNED" -gt 0 ]; then
            echo "ERROR: PR contains unplanned work"
            git log origin/main..HEAD --oneline | grep '\[Unplanned\]'
            exit 1
          fi
          TRIVIAL=$(git log origin/main..HEAD --oneline | grep '\[Trivial\]' || true)
          if [ -n "$TRIVIAL" ]; then
            echo "Validating [Trivial] commits..."
            while IFS= read -r commit; do
              [ -z "$commit" ] && continue
              HASH=$(echo "$commit" | cut -d' ' -f1)
              LINES=$(git show --stat "$HASH" | tail -1 | grep -oP '\d+(?= insertion)' || echo "0")
              LINES_DEL=$(git show --stat "$HASH" | tail -1 | grep -oP '\d+(?= deletion)' || echo "0")
              SRC=$(git show --name-only "$HASH" | grep -c '^src/' || true)
              if [ $((LINES + LINES_DEL)) -gt 20 ] || [ "$SRC" -gt 0 ]; then
                echo "WARNING: Trivial commit may exceed limits: $commit"
              fi
            done <<< "$TRIVIAL"
          fi
          echo "✓ All commits have valid references"

  # =============================================================================
  # Post-Merge (lightweight - only on main push)
  # =============================================================================
  post-merge:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check plan completion evidence
        run: python scripts/check_plan_completion.py --recent-commits 5 --warn-only
