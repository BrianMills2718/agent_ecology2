# Feature: Meta-Process Tooling
# The tooling required to enforce feature-driven-development pattern

feature: meta-process-tooling
planning_mode: detailed  # This is architectural, affects all future work

# === PRD SECTION (What/Why) ===
problem: |
  The feature-driven-development pattern has been documented but lacks enforcement tooling.
  Without tooling:
  - Spec locks are honor-system only (AI could modify locked specs)
  - Spec quality validation is manual
  - Feature coverage (which files belong to which features) is untracked
  - Design sections are not validated

  We need scripts that CI can run to enforce the pattern automatically.

out_of_scope:
  - "Automatic test generation from Given/When/Then specs (complex, separate feature)"
  - "IDE integration or editor plugins"
  - "Visual dashboard for feature status"
  - "Migration of existing plans to features (separate task)"

# === DESIGN SECTION (How) ===
design:
  approach: |
    Create Python scripts in scripts/ that CI can run. Each script focuses on one
    enforcement aspect. Scripts read from acceptance_gates/*.yaml and validate against
    the codebase. Failures exit non-zero for CI integration.

  key_decisions:
    - "Python scripts (consistent with existing scripts/, no new dependencies)"
    - "YAML-based feature definitions (human-readable, machine-parseable)"
    - "Exit codes for CI (0 = pass, 1 = fail, 2 = warning)"
    - "Standalone scripts, not a framework (simpler, easier to understand)"
    - "Lock enforcement via git diff detection (check if locked files modified in PR)"

  risks:
    - "Lock detection may have edge cases with rebases/merges (accepted, can iterate)"
    - "YAML schema changes require updating validation (accepted, schema is simple)"

# === ACCEPTANCE CRITERIA ===
acceptance_criteria:
  - id: AC-1
    scenario: "Successful validation of complete spec"
    category: happy_path
    given:
      - "A feature file exists in acceptance_gates/"
      - "The feature has acceptance_criteria section"
    when: "validate_spec.py runs"
    then:
      - "Script checks minimum 3 scenarios exist"
      - "Script checks happy_path, error_case, edge_case categories present"
      - "Script checks Given/When/Then format"
      - "Script exits 0 if valid, 1 if invalid"
    locked: true

  - id: AC-2
    scenario: "Error when locked file is modified"
    category: error_case
    given:
      - "A feature file has acceptance_criteria with locked: true"
      - "A PR modifies lines within that locked section"
    when: "check_locked_files.py runs against the PR diff"
    then:
      - "Script detects the modification"
      - "Script exits 1 with clear error message"
      - "Script identifies which feature and which section was modified"
    locked: true

  - id: AC-3
    scenario: "Check feature coverage edge case with no features"
    category: edge_case
    given:
      - "Features are defined in acceptance_gates/*.yaml with code: sections"
      - "Source files exist in src/"
    when: "check_feature_coverage.py runs"
    then:
      - "Script reports which src/ files are assigned to features"
      - "Script reports which src/ files are UNASSIGNED"
      - "Script exits 0 if all files assigned, 1 if orphans exist"
    locked: true

  - id: AC-4
    scenario: "Allow autonomous mode without design"
    category: happy_path
    given:
      - "A feature file has planning_mode: autonomous"
      - "The feature has no design section"
    when: "validate_spec.py runs"
    then:
      - "Script does NOT fail for missing design"
      - "Design is only required for detailed mode"
    locked: true

  - id: AC-5
    scenario: "Require design for detailed mode"
    category: error_case
    given:
      - "A feature file has planning_mode: detailed"
      - "The feature has no design section"
    when: "validate_spec.py runs"
    then:
      - "Script fails with clear message about missing design"
      - "Script exits 1"
    locked: true

# === IMPLEMENTATION SECTION ===
adrs: []  # No ADRs directly govern this feature yet

code:
  - scripts/check_locked_files.py
  - scripts/check_plan_completion.py

tests: []

docs:
  - docs/meta/feature-driven-development.md
  - docs/meta/feature-linkage.md
