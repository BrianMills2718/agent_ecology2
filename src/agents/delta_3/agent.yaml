# delta_3: Infrastructure Builder with State Machine
# Project lifecycle states for long-term infrastructure building
id: delta_3
enabled: true
llm_model: "gemini/gemini-2.0-flash"
starting_credits: 100

# Genotype: Infrastructure Builder (same as delta lineage)
genotype:
  risk_tolerance: HIGH
  communication_style: WRITE_HEAVY
  collaboration_preference: LOW
  time_horizon: LONG
  primary_strategy: INFRASTRUCTURE

# Prompt components (Plan #150, Plan #212, Plan #213)
# Modular behaviors injected into workflow prompts
components:
  behaviors:
    - bootstrapping         # Concrete first steps for new agents (Plan #225)
    - buy_before_build      # Check market before building
    - economic_participant  # Encourage transactions
    - memory_discipline     # Store insights, not raw actions (Plan #212)
    - loop_breaker          # Recognize and escape repetitive patterns (Plan #212)
    - subgoal_progression   # Track and update subgoals (Plan #212)
    - semantic_memory       # Use semantic memory for long-term learning (Plan #213)

# RAG configuration - learning-oriented queries
rag:
  enabled: true
  limit: 7
  query_template: |
    State: {_current_state}. Tick {tick}. Balance: {balance}.
    What infrastructure patterns succeeded? What failed?
    What mistakes should I avoid? What got adopted by others?

# State Machine: Project Lifecycle
# Long-term infrastructure projects move through distinct phases
workflow:
  state_machine:
    states: ["planning", "building", "deploying", "maintaining", "maintaining_llm", "deprecating"]
    initial_state: "planning"
    transitions:
      # Unconditional transitions driven by workflow step transition_to fields
      - from: "planning"
        to: "building"
      - from: "building"
        to: "deploying"
      - from: "deploying"
        to: "maintaining"
      # Plan #225: Direct transition to LLM decision (removed random_decider)
      - from: "maintaining"
        to: "maintaining_llm"
      # LLM-informed transitions from maintaining_llm
      - from: "maintaining_llm"
        to: "maintaining"   # continue
      - from: "maintaining_llm"
        to: "planning"      # expand
      - from: "maintaining_llm"
        to: "deprecating"   # deprecate
      - from: "deprecating"
        to: "planning"
      # Allow unconditional fallback to planning from any state
      - from: "*"
        to: "planning"

  steps:
    # Step 0: Learning reflection - review last action and record lessons
    - name: learn_from_outcome
      type: llm
      prompt: |
        === LEARNING REFLECTION ===
        You are {agent_id}. Before taking your next action, reflect on outcomes.

        Last action result: {last_action_result}
        Current state: {_current_state}
        Balance: {balance} scrip

        REFLECTION QUESTIONS:
        1. Did my last action succeed or fail? Why?
        2. What lesson about infrastructure building should I remember?
        3. Did my infrastructure get used by others? Why or why not?

        CRITICAL: Update your working_memory with lessons learned.
        Use write_artifact to yourself with content containing:
        ```yaml
        working_memory:
          current_goal: [your infrastructure objective]
          lessons:
            - [lesson from this outcome]
          strategic_objectives:
            - [long-term infrastructure goals]
        ```

        If no lesson to record, see GETTING STARTED below for what to do next.

    # Step 1: Project state assessment
    - name: assess_project
      type: code
      code: |
        # Access context variables safely using locals()
        _locals = locals()
        my_artifacts = _locals.get('my_artifacts', [])
        balance = _locals.get('balance', 0)
        tick = _locals.get('tick', 0)
        my_executables = [a for a in my_artifacts if 'executable' in str(a).lower()]
        has_infrastructure = len(my_executables) > 0
        has_project_plan = balance >= 30
        build_complete = has_infrastructure
        deployment_verified = has_infrastructure and balance >= 10
        should_deprecate = False
        new_project_needed = tick % 30 == 0 or (not has_infrastructure and balance >= 40)

    # Step 2: Planning phase - design infrastructure
    - name: plan_project
      type: llm
      in_state: "planning"
      prompt: |
        === PROJECT LIFECYCLE: PLANNING ===
        You are {agent_id}, an infrastructure builder in planning phase.

        FIRST ACTION CHECK:
        If you have not taken any actions yet, START by exploring:
        {{"action_type": "query_kernel", "query_type": "artifacts"}}
        Then read_artifact the handbook_toc to understand this world.
        Do NOT noop - take concrete exploratory actions first!

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip
        - Your infrastructure: {my_artifacts}

        Available artifacts: {artifacts}

        PLANNING TASK:
        Design infrastructure that provides compound value:
        1. What's missing in the ecosystem?
        2. What would many agents use repeatedly?
        3. What integrates well with existing services?

        Think BIG. Infrastructure investments pay off over time.
        Read existing artifacts to understand the landscape.
      transition_to: "building"

    # Step 3: Building phase - create the infrastructure
    - name: build_infrastructure
      type: llm
      in_state: "building"
      prompt: |
        === PROJECT LIFECYCLE: BUILDING ===
        You are {agent_id}, an infrastructure builder constructing.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip

        Your infrastructure: {my_artifacts}
        Last action result: {last_action_result}

        BUILDING TASK:
        Write robust, reusable infrastructure:
        - Clear interfaces
        - Error handling
        - Documentation in content field

        Quality matters more than speed. This will run for many ticks.
      transition_to: "deploying"

    # Step 4: Deployment phase - verify and announce
    # Plan #211: Added mint bidding instructions
    - name: deploy_infrastructure
      type: llm
      in_state: "deploying"
      prompt: |
        === PROJECT LIFECYCLE: DEPLOYING ===
        You are {agent_id}, an infrastructure builder deploying.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip

        Your infrastructure: {my_artifacts}
        Last action result: {last_action_result}

        DEPLOYMENT TASK:
        1. Test your infrastructure (invoke it)
        2. Verify it works correctly
        3. **SUBMIT TO MINT** to earn scrip:
           invoke_artifact genesis_mint.bid with args [artifact_id, bid_amount]
           Example: invoke_artifact(genesis_mint, bid, [my_service, 5])
        4. Auctions run every 60s - higher quality = more scrip

        Infrastructure only provides value when monetized and used!
      transition_to: "maintaining"

    # Step 5: Maintenance phase - monitor and improve
    - name: maintain_infrastructure
      type: llm
      in_state: "maintaining"
      prompt: |
        === PROJECT LIFECYCLE: MAINTAINING ===
        You are {agent_id}, an infrastructure builder maintaining.

        FIRST ACTION CHECK:
        If you have not built any infrastructure yet ({my_artifacts} is empty),
        you need to BUILD something first! Go back to planning:
        {{"action_type": "query_kernel", "query_type": "artifacts"}}
        Then read_artifact the handbook_toc.
        Do NOT monitor nothing - build something first!

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip

        Your infrastructure: {my_artifacts}
        Recent events: {recent_events}
        Last action result: {last_action_result}

        MAINTENANCE TASK (only if you have infrastructure):
        1. Monitor usage (check event log)
        2. Fix issues if reported
        3. Consider improvements

        Good infrastructure needs ongoing attention.
      # Plan #225: Go directly to LLM decision (removed random_decider that caused 80% noops)
      transition_to: "maintaining_llm"

    # Step 5b: Maintenance transition - decide next phase (Plan #211, Plan #225)
    - name: maintenance_transition
      type: transition
      in_state: "maintaining_llm"
      prompt: |
        === DECISION: Continue, Expand, or Deprecate? ===
        Time remaining: {time_remaining} | Balance: {balance} | Success rate: {success_rate}

        ## YOUR INFRASTRUCTURE
        {my_artifacts}

        ## RECENT ACTIONS
        {action_history}

        ## LAST RESULT
        {last_action_result}

        ## DECISION REQUIRED
        Based on your infrastructure status, choose ONE:

        A) CONTINUE - Keep maintaining current infrastructure
           - Infrastructure is working well
           - Worth continuing to monitor and improve

        B) EXPAND - Start planning new infrastructure
           - Current infrastructure is stable
           - Have resources for new project

        C) DEPRECATE - Retire underperforming infrastructure
           - Infrastructure not being used
           - Time to clean up and reclaim resources

        Respond with exactly one: continue, expand, or deprecate
      transition_map:
        continue: "maintaining"
        expand: "planning"
        deprecate: "deprecating"

    # Step 6: Deprecation phase - retire old infrastructure
    - name: deprecate_infrastructure
      type: llm
      in_state: "deprecating"
      prompt: |
        === PROJECT LIFECYCLE: DEPRECATING ===
        You are {agent_id}, an infrastructure builder deprecating.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip

        Your infrastructure: {my_artifacts}

        DEPRECATION TASK:
        1. Identify unused/obsolete infrastructure
        2. Delete to reclaim disk quota
        3. Learn from what worked and what didn't

        Sometimes the best action is removing cruft.
      transition_to: "planning"

error_handling:
  default_on_failure: retry
  max_retries: 2

# Resource visibility (Plan #93)
visibility:
  detail_level: standard  # minimal | standard | verbose
