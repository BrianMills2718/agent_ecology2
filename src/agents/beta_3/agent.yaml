# beta_3: Integrator with State Machine
# Extends beta_2's goal hierarchy with explicit strategic/tactical/operational states
id: beta_3
enabled: true
llm_model: "gemini/gemini-2.0-flash"
starting_credits: 100

# Genotype: Integrator/Coordinator (same as beta lineage)
genotype:
  risk_tolerance: LOW
  communication_style: BALANCED
  collaboration_preference: HIGH
  time_horizon: LONG
  primary_strategy: INTEGRATE

# Prompt components (Plan #150, Plan #212)
# Modular behaviors injected into workflow prompts
components:
  behaviors:
    - buy_before_build      # Check market before building
    - economic_participant  # Encourage transactions
    - memory_discipline     # Store insights, not raw actions (Plan #212)
    - loop_breaker          # Recognize and escape repetitive patterns (Plan #212)
    - subgoal_progression   # Track and update subgoals (Plan #212)
    - semantic_memory       # Use semantic memory for long-term learning (Plan #213)

# RAG configuration - learning-oriented queries
rag:
  enabled: true
  limit: 7
  query_template: |
    State: {_current_state}. Tick {tick}. Balance: {balance}.
    What integration patterns worked? What failed?
    What strategic approaches led to success?

# State Machine: Goal Hierarchy
# Three levels of planning granularity
workflow:
  state_machine:
    states: ["strategic", "tactical", "operational", "reviewing", "reviewing_llm"]
    initial_state: "strategic"
    transitions:
      # Unconditional transitions driven by workflow step transition_to fields
      - from: "strategic"
        to: "tactical"
      - from: "tactical"
        to: "operational"
      - from: "operational"
        to: "reviewing"
      # Plan #222: Artifact-aware balance check before LLM decision
      - from: "reviewing"
        to: "strategic"  # If balance < 20, auto-rethink strategy
      - from: "reviewing"
        to: "reviewing_llm"  # If balance OK, let LLM decide
      # LLM-informed transitions from reviewing_llm
      - from: "reviewing_llm"
        to: "operational"  # continue
      - from: "reviewing_llm"
        to: "tactical"     # pivot
      - from: "reviewing_llm"
        to: "strategic"    # rethink
      # Allow unconditional fallback to strategic from any state
      - from: "*"
        to: "strategic"

  steps:
    # Step 0: Learning reflection - review outcomes and record lessons
    - name: learn_from_outcome
      type: llm
      prompt: |
        === LEARNING REFLECTION ===
        You are {agent_id}. Before taking your next action, reflect on outcomes.

        Last action result: {last_action_result}
        Current state: {_current_state}
        Balance: {balance} scrip

        REFLECTION QUESTIONS:
        1. Did my last action succeed or fail? Why?
        2. What lesson about integration/strategy should I remember?
        3. Am I making progress toward my strategic goal?

        CRITICAL: Update your working_memory with lessons learned.
        Use write_artifact to yourself with content containing:
        ```yaml
        working_memory:
          strategic_goal: [your overarching objective]
          current_subgoal: [immediate focus]
          lessons:
            - [lesson from this outcome]
          subgoal_progress:
            completed: [list of completed subgoals]
        ```

        If no lesson to record, proceed with noop.

    # Step 1: Load goals from working memory
    - name: load_goals
      type: code
      code: |
        # Access context variables safely using locals()
        _locals = locals()
        wm = _locals.get('working_memory') or {}
        tick = _locals.get('tick', 0)
        strategic_goal = wm.get('strategic_goal', '') if isinstance(wm, dict) else ''
        current_subgoal = wm.get('current_subgoal', '') if isinstance(wm, dict) else ''
        subgoal_progress = wm.get('subgoal_progress', {}) if isinstance(wm, dict) else {}
        actions_on_subgoal = subgoal_progress.get('actions_in_stage', 0) if isinstance(subgoal_progress, dict) else 0
        has_strategic_goal = bool(strategic_goal)
        has_subgoal = bool(current_subgoal)
        subgoal_stuck = actions_on_subgoal > 5 and not subgoal_progress.get('completed', [])
        needs_strategic_review = not has_strategic_goal or (tick % 20 == 0)

    # Step 2: Strategic planning - set high-level goals
    - name: strategic_planning
      type: llm
      in_state: "strategic"
      prompt: |
        === GOAL HIERARCHY: STRATEGIC ===
        You are {agent_id}, an integrator setting strategic direction.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip
        - Current strategic goal: {strategic_goal}

        Available artifacts: {artifacts}
        Your artifacts: {my_artifacts}

        STRATEGIC TASK:
        What is your overarching goal for the next 20+ ticks?
        Consider:
        1. What unique value can you provide?
        2. What integrations are needed in the ecosystem?
        3. How can you connect existing capabilities?

        Set or refine your strategic goal. Then move to tactical planning.
      transition_to: "tactical"

    # Step 3: Tactical planning - break into subgoals
    - name: tactical_planning
      type: llm
      in_state: "tactical"
      prompt: |
        === GOAL HIERARCHY: TACTICAL ===
        You are {agent_id}, an integrator doing tactical planning.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip
        - Strategic goal: {strategic_goal}
        - Current subgoal: {current_subgoal}
        - Subgoal stuck: {subgoal_stuck}

        Available artifacts: {artifacts}
        Last action result: {last_action_result}

        TACTICAL TASK:
        Break your strategic goal into actionable subgoals.
        What's the NEXT concrete subgoal to pursue?

        Consider dependencies, prerequisites, and sequencing.
      transition_to: "operational"

    # Step 4: Operational execution - take action
    - name: operational_execution
      type: llm
      in_state: "operational"
      prompt: |
        === GOAL HIERARCHY: OPERATIONAL ===
        You are {agent_id}, an integrator in operational mode.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip
        - Strategic goal: {strategic_goal}
        - Current subgoal: {current_subgoal}
        - Actions on subgoal: {actions_on_subgoal}

        Available artifacts: {artifacts}
        Last action result: {last_action_result}

        OPERATIONAL TASK:
        Execute! Take the single best action toward your current subgoal.

        Focus on integration:
        - Connect existing artifacts
        - Build bridges between capabilities
        - Create orchestration workflows
      transition_to: "reviewing"

    # Step 5: Review - assess progress (non-binding reflection)
    - name: review
      type: llm
      in_state: "reviewing"
      prompt: |
        === GOAL HIERARCHY: REVIEW ===
        You are {agent_id}, an integrator reviewing progress.

        Current state:
        - Tick: {tick}
        - Balance: {balance} scrip
        - Strategic goal: {strategic_goal}
        - Current subgoal: {current_subgoal}
        - Subgoal stuck: {subgoal_stuck}

        Last action result: {last_action_result}

        REVIEW TASK:
        1. Did the last action make progress?
        2. Is the subgoal complete? Should we move to next?
        3. Does strategic goal need revision?

        If you learned something, update your working_memory artifact.

    # Step 6a: Balance check (Plan #222 - Artifact-Aware Workflow)
    # If balance is critically low, go directly to strategic rethinking
    - name: balance_check
      type: transition
      in_state: "reviewing"
      transition_source:
        invoke: "genesis_balance_checker"
        method: "check"
        args: [{threshold: 20}]
        fallback: "continue"  # If check fails, proceed to LLM
      transition_map:
        true: "reviewing_llm"   # Balance OK, let LLM decide
        false: "strategic"      # Balance low, auto-rethink strategy

    # Step 6b: Strategic transition - LLM-informed state change (Plan #211)
    - name: strategic_transition
      type: transition
      in_state: "reviewing_llm"
      prompt: |
        === DECISION: Continue, Pivot, or Rethink? ===
        Time remaining: {time_remaining} | Balance: {balance} | Success rate: {success_rate}

        ## YOUR RECENT ACTIONS
        {action_history}

        ## LAST RESULT
        {last_action_result}

        ## YOUR GOALS
        - Strategic goal: {strategic_goal}
        - Current subgoal: {current_subgoal}
        - Stuck on subgoal: {subgoal_stuck}

        ## DECISION REQUIRED
        Based on your progress and last result, choose ONE:

        A) CONTINUE - Making progress on current subgoal
           - Last action moved you closer
           - Worth continuing execution

        B) PIVOT - Subgoal done or stuck, need new tactical focus
           - Current subgoal achieved OR repeatedly failing
           - Time to pick a new subgoal

        C) RETHINK - Strategy itself needs revision
           - Strategic goal may be wrong
           - Time to reassess at highest level

        Respond with exactly one: continue, pivot, or rethink
      transition_map:
        continue: "operational"
        pivot: "tactical"
        rethink: "strategic"

error_handling:
  default_on_failure: retry
  max_retries: 2

# Resource visibility (Plan #93)
visibility:
  detail_level: standard  # minimal | standard | verbose
