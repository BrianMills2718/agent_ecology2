#!/bin/bash
# Pre-commit hook for agent_ecology
# Catches issues before they reach CI

set -e

echo "Running pre-commit checks..."

# Get the repo root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Get staged Python files
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

# 1. Auto-generate plan index FIRST (before doc-coupling check)
# This ensures CLAUDE.md is staged if plan files changed, preventing false
# coupling violations when architecture docs trigger the CLAUDE.md coupling.
echo "Regenerating plan index..."
python scripts/generate_plan_index.py --write 2>/dev/null || {
    echo ""
    echo "ERROR: Failed to generate plan index"
    echo ""
    exit 1
}
# Stage the regenerated index
git add docs/plans/CLAUDE.md 2>/dev/null || true

# 2. Doc-coupling check (strict violations only)
echo "Checking doc-code coupling..."
if ! python scripts/check_doc_coupling.py --strict 2>/dev/null; then
    echo ""
    echo "ERROR: Doc-coupling violation detected!"
    echo "Run 'python scripts/check_doc_coupling.py --suggest' to see which docs to update."
    echo ""
    exit 1
fi

# 3. Mypy on changed src/ files
STAGED_SRC=$(echo "$STAGED_PY" | grep '^src/' || true)
if [ -n "$STAGED_SRC" ]; then
    echo "Running mypy on changed files..."
    MYPY_FILES=""
    for f in $STAGED_SRC; do
        case "$f" in
            src/config.py|src/world/*.py|src/agents/*.py)
                MYPY_FILES="$MYPY_FILES $f"
                ;;
        esac
    done

    if [ -n "$MYPY_FILES" ]; then
        if ! python -m mypy --strict --ignore-missing-imports $MYPY_FILES 2>/dev/null; then
            echo ""
            echo "ERROR: mypy type check failed!"
            echo ""
            exit 1
        fi
    fi
fi

# 4. Validate coupling config
echo "Validating coupling config..."
if ! python scripts/check_doc_coupling.py --validate-config 2>/dev/null; then
    echo ""
    echo "ERROR: Invalid doc-coupling config"
    echo ""
    exit 1
fi

# 5. Plan content validation (status must match content)
echo "Validating plan content..."
VALIDATION_ERRORS=""
for plan_file in docs/plans/[0-9]*_*.md; do
    [ -f "$plan_file" ] || continue

    # Get status line
    STATUS=$(grep -m1 '^\*\*Status:\*\*' "$plan_file" 2>/dev/null | head -1 || true)

    # Skip validation for Deferred/In Progress/Post-V1 (these are works in progress)
    if echo "$STATUS" | grep -qiE 'deferred|in.progress|post-v1'; then
        continue
    fi

    # Check: Planned status requires plan content
    # Accept: ## Plan, ## Implementation, ## Solution, ## Proposed, ## Changes
    if echo "$STATUS" | grep -q 'ðŸ“‹'; then
        if ! grep -qE '^## (Plan|Implementation|Solution|Proposed|Changes)' "$plan_file" 2>/dev/null; then
            VALIDATION_ERRORS="$VALIDATION_ERRORS\n  - $plan_file: Status is 'Planned' but missing plan content section"
        fi
    fi

    # Note: Complete verification evidence check disabled due to many pre-existing
    # violations. New completions should use complete_plan.py which adds evidence.
    # TODO: Enable once existing plans are backfilled with evidence
done

if [ -n "$VALIDATION_ERRORS" ]; then
    echo ""
    echo "ERROR: Plan content validation failed:"
    echo -e "$VALIDATION_ERRORS"
    echo ""
    echo "Fix the plan files or update their status."
    exit 1
fi

# 6. Branch divergence check (prevents merge conflicts)
echo "Checking branch freshness..."
git fetch origin 2>/dev/null || true  # Silent fetch, don't fail if offline

BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || true
REMOTE="origin/$BRANCH"

# Only check if remote branch exists
if git rev-parse --verify "$REMOTE" >/dev/null 2>&1; then
    LOCAL_ONLY=$(git rev-list "$REMOTE..HEAD" --count 2>/dev/null || echo "0")
    REMOTE_ONLY=$(git rev-list "HEAD..$REMOTE" --count 2>/dev/null || echo "0")

    if [ "$REMOTE_ONLY" -gt 0 ] && [ "$LOCAL_ONLY" -gt 0 ]; then
        echo ""
        echo "ERROR: Branch has diverged from remote!"
        echo "  Local commits not on remote: $LOCAL_ONLY"
        echo "  Remote commits not local: $REMOTE_ONLY"
        echo ""
        echo "Resolution:"
        echo "  git pull --rebase origin $BRANCH"
        echo ""
        echo "Then retry your commit."
        echo "Bypass with: git commit --no-verify (not recommended)"
        exit 1
    fi

    if [ "$REMOTE_ONLY" -gt 5 ]; then
        echo "WARNING: Branch is $REMOTE_ONLY commits behind remote"
        echo "Consider: git pull --rebase origin $BRANCH"
    fi
fi

echo "Pre-commit checks passed!"
