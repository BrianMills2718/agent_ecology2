#!/bin/bash
# Pre-commit hook for agent_ecology
# Checks: plan index, doc-coupling, mypy

set -e

echo "Running pre-commit checks..."

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

# 1. Auto-generate plan index
echo "Regenerating plan index..."
python scripts/generate_plan_index.py --write 2>/dev/null || {
    echo "ERROR: Failed to generate plan index"
    exit 1
}
git add docs/plans/CLAUDE.md 2>/dev/null || true

# 2. Doc-coupling check (respects meta-process.yaml strict_doc_coupling setting)
echo "Checking doc-code coupling..."
STRICT_FLAG="--strict"
if python scripts/meta_config.py --get enforcement.strict_doc_coupling 2>/dev/null | grep -qi "false"; then
    STRICT_FLAG=""
fi
if ! python scripts/check_doc_coupling.py $STRICT_FLAG --weight-aware 2>/dev/null; then
    echo ""
    echo "ERROR: Doc-coupling violation detected!"
    echo "Run 'python scripts/check_doc_coupling.py --suggest' to see which docs to update."
    echo ""
    exit 1
fi

# 3. Mypy on changed src/ files (blocking)
STAGED_SRC=$(echo "$STAGED_PY" | grep '^src/' || true)
if [ -n "$STAGED_SRC" ]; then
    echo "Running mypy on changed files..."
    if ! python -m mypy --strict --ignore-missing-imports --follow-imports=silent $STAGED_SRC 2>/dev/null; then
        echo ""
        echo "ERROR: mypy type check failed!"
        echo ""
        exit 1
    fi
fi

echo "Pre-commit checks passed!"
