#!/bin/bash
# Commit-msg hook for agent_ecology
# Enforces that all commits reference a plan

COMMIT_MSG_FILE="$1"
FIRST_LINE=$(head -n1 "$COMMIT_MSG_FILE")

# Allow merge commits
if [[ "$FIRST_LINE" =~ ^Merge ]]; then
    exit 0
fi

# Allow fixup/squash commits
if [[ "$FIRST_LINE" =~ ^(fixup!|squash!) ]]; then
    exit 0
fi

# Check for plan reference: [Plan #N]
if [[ "$FIRST_LINE" =~ ^\[Plan\ \#[0-9]+\] ]]; then
    exit 0
fi

# [Unplanned] requires explicit opt-in via environment variable
if [[ "$FIRST_LINE" =~ ^\[Unplanned\] ]]; then
    if [[ "$ALLOW_UNPLANNED" == "1" ]]; then
        echo ""
        echo "WARNING: Unplanned work - ALLOW_UNPLANNED=1 set"
        echo "Remember: Create a plan entry before merging to main."
        echo ""
        exit 0
    else
        echo ""
        echo "ERROR: Unplanned work requires explicit opt-in!"
        echo ""
        echo "If this is truly unplanned work (quick fix, typo, etc.):"
        echo "  ALLOW_UNPLANNED=1 git commit -m \"[Unplanned] ...\""
        echo ""
        echo "For substantial work, create a plan first:"
        echo "  1. Create docs/plans/NN_description.md"
        echo "  2. Use [Plan #NN] prefix in commit"
        echo ""
        echo "Why? Unplanned work skips TDD, testing requirements, and review."
        echo "Most 'quick fixes' benefit from the planning process."
        echo ""
        exit 1
    fi
fi

# Reject commits without plan reference
echo ""
echo "ERROR: Commit message must reference a plan!"
echo ""
echo "Format: [Plan #N] Short description"
echo "   e.g. [Plan #3] Implement docker isolation"
echo ""
echo "For truly unplanned work (requires explicit opt-in):"
echo "   ALLOW_UNPLANNED=1 git commit -m \"[Unplanned] ...\""
echo ""
exit 1
